import{N as $,P as C,Q as T,m as q,n as F,h as E,R as L,S as B,_ as M,r as u,o as r,c as o,a as h,t as c,b as f,w as _,e as b,j as p,F as g,g as m,f as D,T as N}from"./index-38693b26.js";import{S as R,F as G,M as O,V as A,I as z,a as J,b as Q,i as V,g as U}from"./ServiceCodeErrorWindow-1c3de638.js";import{b as H}from"./service.version-b38dea85.js";import{F as K}from"./FormItemTip-fee82ce6.js";const X={name:"ServiceInstaller",components:{FormItemTip:K,ServiceCodeErrorWindow:R,MergeWindow:$,ProjectSelect:C,DirectorySelect:T,FieldSetting:G,MySqlFieldSelect:O,VariableInput:A,InstallRadio:z,InstallInput:J,InstallCheckbox:Q},props:{installing:{},uninstalling:{},space:{required:!0},service:{required:!0},plugin:{required:!1},servicePrice:{required:!0},serviceLease:{required:!1},version:{required:!0},withProject:{default:!0},projectConfig:{},withTitle:{default:!1},withInstallButton:{default:!1}},data(){return{isWorking:{install:!1,uninstall:!1},versionData:null,variables:[]}},computed:{...q(["currentProject","currentProjectDetail","currentDatabase","currentDatabaseDetail"]),isPlugin(){return this.plugin!=null},serviceVariables(){return this.variables},contentWrapStyle(){return this.withTitle?"border-top: 3px; margin-top: 20px;":"padding-top: 0; border-top: 0;margin-top: 0;"},unique(){return[this.space,this.service,this.version]}},watch:{unique(){this.fetchVersion()},"isWorking.install":function(){this.$emit("update:installing",this.isWorking.install)},"isWorking.uninstall":function(){this.$emit("update:uninstalling",this.isWorking.uninstall)},projectConfig(){this.initVariables()},plugin(){this.initVariables()}},methods:{...F(["setInstallData"]),...E(["refreshBalance"]),fetchVersion(){H({space:this.space,service:this.service,plugin:this.plugin,version:this.version}).then(e=>{this.versionData=e,this.initVariables()}).catch(e=>{this.$tip.apiFailed(e)})},install(){if(this.serviceLease!=null){this.__install();return}if(this.servicePrice<50){this.__install();return}this.installConfirm(this.servicePrice).then(()=>{this.__install()}).catch(()=>{})},initVariables(){this.versionData!=null&&(this.variables=JSON.parse(this.versionData.variables).map(e=>this.__initVariableValue(e)))},__install(){if(this.isWorking.install)return;if(this.isWorking.install=!0,this.currentProject==null||this.currentProject===""){this.$tip.warning(this.$t("service.selectProject")),this.isWorking.install=!1;return}const e=this.__getInstallVariables(this.variables);if(!this.__checkVariables(e)){this.isWorking.install=!1;return}L({projectId:this.currentProject,database:this.currentDatabase,space:this.space,service:this.service,plugin:this.plugin,version:this.version,variables:e}).then(i=>{this.isWorking.install=!1,this.$tip.success(this.$t("service.installSuccessfully")),this.setInstallData(i),this.refreshBalance(),this.$emit("installed")}).catch(i=>{if(i.code===6e3){this.$refs.serviceCodeErrorWindow.open(i.errorData);return}this.$tip.apiFailed(i)}).finally(()=>{this.isWorking.install=!1})},uninstall(){if(this.serviceLease!=null){this.__uninstall();return}if(this.servicePrice<50){this.__uninstall();return}this.uninstallConfirm().then(()=>{this.__uninstall()}).catch(()=>{})},__uninstall(){this.isWorking.uninstall||(this.isWorking.uninstall=!0,B({projectId:this.currentProject,database:this.currentDatabase,space:this.space,service:this.service,plugin:this.plugin,version:this.version,variables:this.__getInstallVariables(this.variables)}).then(e=>{this.isWorking.uninstall=!1,this.$tip.success(this.$t("service.uninstallSuccessfully")),this.setInstallData(e),this.$emit("uninstalled")}).catch(e=>{if(e.code===6e3){this.$refs.serviceCodeErrorWindow.open(e.errorData);return}this.$tip.apiFailed(e)}).finally(()=>{this.isWorking.uninstall=!1}))},__checkVariables(e,i){for(const t of e){if(t.inputType==="query_model"||t.inputType==="table"){for(const s of t.children){const n=s.value;for(const l of s.children){if(!l.required)continue;const d=n.find(y=>V(y[l.name]));if(d!=null)return this.$tip.warning(this.$t("service.fieldMissingValueTip",{fieldGroupLabel:s.label,emptyFieldName:d.name,fieldVariableLabel:l.label})),!1}}continue}if(t.inputType==="select"){const s=t.value;if(t.required&&s.value==null)return this.__tipEmptyVariable(t,i),!1;if(s.value!=null){const n=t.options.find(l=>l.value===s.value);if(n.settings.length>0){for(const l of n.settings)if(V(s.settings[l.name]))return this.$tip.warning(this.$t("service.variableMissingSettingTip",{variable:t.label,settingLabel:l.label})),!1}}continue}if(t.type==="group"){if(!this.__checkVariables(t.children,t.label))return!1;continue}if(V(t.value))return this.__tipEmptyVariable(t,i),!1}return!0},__tipEmptyVariable(e,i){i!=null?this.$tip.warning(this.$t("service.missingGroupVariableValueTip",{variable:e.label,groupName:i})):this.$tip.warning(this.$t("service.missingVariableValueTip",{variable:e.label}))},__getInstallVariables(e){return e.map(i=>{if(i.inputType==="select"){const t=i.options.find(n=>n.value===i.value.value);if(t==null)return i;const s={};for(const n of t.settings)s[n.name]=n.value;i.value.settings=s}return i.type==="group"&&(i.children=this.__getInstallVariables(i.children)),i})},__initVariableValue(e,i){if(i==null&&this.projectConfig!=null)if(this.isPlugin){const t=this.projectConfig.plugins||this.projectConfig.services;if(t!=null){const s=t[this.plugin];if(s!=null){const n=s.variables.findLast(l=>l.name===e.name);n!=null&&(i=n.value)}}if(i==null){const s=this.projectConfig.service||this.projectConfig.main;if(s!=null){let n=null;for(const d in s){n=d;break}const l=s[n].variables[e.name];i=l,l!=null&&l.constructor!==e.defaultValue.constructor&&(i=null)}}}else{const t=this.projectConfig.service||this.projectConfig.main;if(t!=null){const s=t[this.service];if(s!=null){const n=s.variables.findLast(l=>l.name===e.name);n!=null&&(i=n.value)}}}if(i!=null){if(e.inputType==="table"||e.inputType==="query_model"){for(const t in i.settings){const s=e.children.find(n=>n.name===t);s!=null&&(s.value=i.settings[t])}return e.value=i.value,e}return e.type==="group"?(e.children.forEach(t=>this.__initVariableValue(t,i[t.name])),e):(e.value=i,e)}if(i=e.defaultValue,i=i??U(e.inputType),e.inputType==="table"||e.inputType==="query_model"){for(const t of e.children)t.value=t.defaultValue;return e.value=i,e}return e.type==="group"?(e.children.forEach(t=>{t.value=t.defaultValue}),e):(e.value=i,e)}},created(){this.fetchVersion()}},Y={class:"service-installer"},Z={key:0,class:"nav"},x={class:"title"},ee={key:0,class:"install"},te={class:"install-tip"},ie={class:"form-wrap"},se={key:1,class:"label-wrap"},ne={key:1,class:"group-vars"},le={class:"text-info-1 text-mini"},re={key:0},ae={key:1,class:"parameters-holder"};function oe(e,i,t,s,n,l){const d=u("el-button"),y=u("ProjectSelect"),k=u("FormItemTip"),j=u("el-form-item"),S=u("ArrowRight"),I=u("el-icon"),w=u("VariableInput"),P=u("el-form"),W=u("ServiceCodeErrorWindow");return r(),o("div",Y,[t.withTitle?(r(),o("div",Z,[h("div",x,[h("h4",null,"@"+c(t.space)+"/"+c(t.service)+c(t.version==null?"":" · "+t.version.toUpperCase())+" · "+c(e.$t("service.install2")),1)]),t.withInstallButton?(r(),o("div",ee,[f(d,{type:"important",onClick:l.install,disabled:n.isWorking.install},{default:_(()=>[b(c(n.isWorking.install?e.$t("service.installing"):e.$t("service.install")),1)]),_:1},8,["onClick","disabled"])])):p("",!0)])):p("",!0),h("div",{class:"content-wrap",style:N(l.contentWrapStyle)},[t.withProject||l.serviceVariables.length>0?(r(),o(g,{key:0},[h("p",te,c(e.$t("service.withParametersTip")),1),h("div",ie,[f(P,null,{default:_(()=>[t.withProject?(r(),m(j,{key:0,label:e.$t("project.project"),required:"",class:"form-item-project"},{default:_(()=>[f(y,{"model-value":e.currentProject,"with-block":!0,"with-prefix":!1,onChange:i[0]||(i[0]=a=>e.$emit("change-project",a))},null,8,["model-value"]),e.currentProjectDetail!=null?(r(),m(k,{key:0,content:`服务安装后代码将写入<em>${e.currentProjectDetail.codespace}</em>目录。`},null,8,["content"])):p("",!0)]),_:1},8,["label"])):p("",!0),(r(!0),o(g,null,D(l.serviceVariables,a=>(r(),o(g,null,[a.hidden?p("",!0):(r(),m(j,{key:a.name,label:a.label,required:a.required},{label:_(()=>[a.type==="variable"?(r(),o(g,{key:0},[b(c(a.label),1)],64)):(r(),o("div",se,[h("span",null,c(a.label),1),f(I,null,{default:_(()=>[f(S)]),_:1})]))]),default:_(()=>[a.type==="variable"?(r(),m(w,{key:0,variable:a},null,8,["variable"])):a.type==="group"?(r(),o("ul",ne,[(r(!0),o(g,null,D(a.children,v=>(r(),o("li",{key:`${a.name}_${v.name}`},[h("label",le,[v.required?(r(),o("em",re,"*")):p("",!0),b(c(v.label),1)]),f(w,{variable:v},null,8,["variable"])]))),128))])):p("",!0),a.inputType==="datasource"&&e.currentDatabaseDetail!=null?(r(),m(k,{key:2,content:`基础信息：${e.currentDatabaseDetail.host}:${e.currentDatabaseDetail.port}/${e.currentDatabaseDetail.schema}`},null,8,["content"])):p("",!0)]),_:2},1032,["label","required"]))],64))),256))]),_:1})])],64)):(r(),o("div",ae,[h("p",null,c(e.$t("service.withoutParametersTip")),1)]))],4),f(W,{ref:"serviceCodeErrorWindow"},null,512)])}const fe=M(X,[["render",oe],["__scopeId","data-v-c68f6153"]]);export{fe as S};
