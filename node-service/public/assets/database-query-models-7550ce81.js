import{_ as F,r as b,o as r,u as M,w as g,d as i,c as h,x as w,F as V,b as s,O as P,v as j,J as S,f as C,I as x,Q as E,t as T,g as k,p as L,h as D,e as $,m as W,R as Q,S as O}from"./index-509f7063.js";import{a as z,I as J}from"./InnerRouterViewWindow-7b44fd09.js";const B={name:"Table",props:{x:{default:0},y:{default:0},fieldHeight:{default:30},table:{required:!0},relations:{required:!0},selected:{default:!1}},data(){const t=this;return{layerConfig:{x:t.x,y:t.y,draggable:!1}}},computed:{backgroundConfig(){return{width:200,height:(this.visibleFields.length+1)*this.fieldHeight,fill:"#fafafa"}},tableNameConfig(){return{text:this.table.name,x:10,y:8,fontSize:15,fill:"#fff"}},tableHeaderConfig(){return{width:200,height:this.fieldHeight,fill:this.table.type==="MAIN"?"#FC777D":"#666"}},relation(){return this.relations.find(t=>t.endTable===this.table.name)},visibleFields(){return this.table.fields.filter(t=>t.visible===!0)}},watch:{selected(t){if(t){this.select();return}this.select(!1)}},methods:{selectTable(t){this.$emit("table:select",this.table.id)},select(t=!0){const e=this.$refs.background.getNode();t?(e.setAttr("stroke",(this.table.type==="MAIN","#FC777D")),e.setAttr("strokeWidth",5)):e.setAttr("strokeWidth",0)},handleHeaderMouseover(t){this.getNode().draggable(!0),window.document.body.style.cursor="move"},handleHeaderMouseleave(t){this.getNode().draggable(!1),window.document.body.style.cursor="default"},getNode(){return this.$refs.table.getNode()},handleFieldMouseDown(t){this.getNode().draggable(!1),this.$emit("field:mousedown",{table:this.table,field:t})},handleFieldMouseUp(t){this.getNode().draggable(!0),this.$emit("field:mouseup",{table:this.table,field:t})}}};function K(t,e,l,_,o,n){const d=b("v-rect"),c=b("v-text"),m=b("v-layer");return r(),M(m,{ref:"table",config:o.layerConfig},{default:g(()=>[i(d,{ref:"background",config:n.backgroundConfig},null,8,["config"]),i(d,{config:n.tableHeaderConfig,onMouseover:n.handleHeaderMouseover,onMouseleave:n.handleHeaderMouseleave,onClick:n.selectTable},null,8,["config","onMouseover","onMouseleave","onClick"]),i(c,{config:n.tableNameConfig,onMouseover:n.handleHeaderMouseover,onMouseleave:n.handleHeaderMouseleave,onClick:n.selectTable},null,8,["config","onMouseover","onMouseleave","onClick"]),(r(!0),h(V,null,w(n.visibleFields,(a,f)=>(r(),M(d,{key:a.name,config:{y:f*l.fieldHeight+n.tableHeaderConfig.height,width:200,height:l.fieldHeight,fill:"#fff"},onMousedown:u=>n.handleFieldMouseDown(a),onMouseup:u=>n.handleFieldMouseUp(a)},null,8,["config","onMousedown","onMouseup"]))),128)),(r(!0),h(V,null,w(n.visibleFields,(a,f)=>(r(),M(c,{key:a,config:{text:a.name,x:10,y:f*l.fieldHeight+n.tableHeaderConfig.height+10,fontSize:13,fill:"#333"},onMousedown:u=>n.handleFieldMouseDown(a),onMouseup:u=>n.handleFieldMouseUp(a)},null,8,["config","onMousedown","onMouseup"]))),128))]),_:1},8,["config"])}const A=F(B,[["render",K]]);const R={join:{color:"#eee",hoverColor:"#FC777D",selectedColor:"#FC777D"},aggregate:{color:"#FFE957",hoverColor:"#FFE957",selectedColor:"#FFE957"}},G={name:"RelationLine",props:{start:{required:!0},end:{required:!0},lineType:{required:!0}},computed:{position(){return[this.start,this.end]}},watch:{position(){this.init()}},data(){return{lineConfig:{x:0,y:0,stroke:"#ccc",strokeWidth:2,lineJoin:"round",lineCap:"round"}}},methods:{highlight(t=!0){const e=this.$refs.line.getNode();t?(e.setAttr("stroke",R[this.lineType].hoverColor),e.setAttr("strokeWidth",3),e.zIndex(100)):(e.setAttr("stroke",R[this.lineType].color),e.setAttr("strokeWidth",2),e.zIndex(1))},init(){this.lineConfig.stroke=R[this.lineType].color;const t=[];this.start.y!==this.end.y&&(t.push(this.start.x+(this.end.x-this.start.x)/2),t.push(this.start.y),t.push(this.start.x+(this.end.x-this.start.x)/2),t.push(this.end.y)),this.lineConfig.points=[this.start.x,this.start.y,...t,this.end.x,this.end.y]}},created(){this.init()}};function X(t,e,l,_,o,n){const d=b("v-line");return r(),M(d,{ref:"line",config:o.lineConfig,onMouseenter:e[0]||(e[0]=c=>n.highlight(!0)),onMouseleave:e[1]||(e[1]=c=>n.highlight(!1))},null,8,["config"])}const q=F(G,[["render",X],["__scopeId","data-v-57a3cba2"]]);const Y={name:"SQLLine",props:{type:{},indent:{default:0},visible:{default:!0}}},Z={class:"code"},ee={class:"opera"},te={key:0},le={key:1},ne={key:2};function ae(t,e,l,_,o,n){const d=b("el-button");return r(),h("div",{class:x(["sql-line",{"sql-line__hide":!l.visible}]),style:E({"padding-left":l.indent+"px"})},[s("p",Z,[P(t.$slots,"default",{},void 0,!0)]),s("ul",ee,[l.type==="field"?(r(),h("li",te,[j(i(d,{icon:"View",onClick:e[0]||(e[0]=c=>t.$emit("update:visible",!1))},null,512),[[S,l.visible]]),j(i(d,{icon:"Hide",onClick:e[1]||(e[1]=c=>t.$emit("update:visible",!0))},null,512),[[S,!l.visible]])])):C("",!0),l.type==="virtual-field"?(r(),h("li",le,[i(d,{icon:"Delete",onClick:e[2]||(e[2]=c=>t.$emit("field:delete",!1))})])):C("",!0),l.type==="select"?(r(),h("li",ne,[i(d,{icon:"Plus",onClick:e[3]||(e[3]=c=>t.$emit("field:create"))})])):C("",!0)])],6)}const se=F(Y,[["render",ae],["__scopeId","data-v-060a58c7"]]);const ie={name:"DynamicWidthInput",props:{modelValue:{}},methods:{handleInput(t){this.$emit("update:modelValue",t.target.innerText)}}};function oe(t,e,l,_,o,n){return r(),h("div",{class:"dynamic-width-input",contenteditable:!0,onInput:e[0]||(e[0]=(...d)=>n.handleInput&&n.handleInput(...d))},T(l.modelValue),33)}const re=F(ie,[["render",oe],["__scopeId","data-v-c260d0ae"]]);const de={name:"TableSetting",components:{DynamicWidthInput:re,SQLLine:se},props:{table:{required:!0},tableJoins:{type:Array},aggregates:{type:Array}},methods:{edit(){console.log(this.$el.querySelector(".wrap").innerText)},createVirtualField(){this.table.fields.push({name:"virtual1",alias:"virtual1",type:"int",comment:"Virtual field 1",isVirtual:!0}),this.$emit("field:change")},deleteVirtualField(t){this.table.fields.splice(t,1),this.$emit("field:change")},getAggregate(t){const e=this.aggregates.find(l=>l.field.name===t.name);return e??null}}},y=t=>(L("data-v-a542a2a6"),t=t(),D(),t),ue={class:"toolbar"},ce={key:0,class:"wrap"},me=y(()=>s("em",null,"SELECT",-1)),he=y(()=>s("em",null,"SELECT",-1)),ge=y(()=>s("span",null,"(",-1)),_e=y(()=>s("span",null,".",-1)),be=y(()=>s("span",null,")",-1)),fe=y(()=>s("em",null,"FROM",-1)),pe=y(()=>s("span",null,")",-1)),ye=y(()=>s("em",null,"AS",-1)),ve=y(()=>s("span",{class:"comment"},"#",-1)),Ve=y(()=>s("span",null,".",-1)),Te=y(()=>s("em",null,"AS",-1)),Me=y(()=>s("em",null,"AS",-1)),Ce=y(()=>s("span",{class:"comment"},"#",-1)),we=y(()=>s("em",null,"FROM",-1)),Fe=y(()=>s("em",null,"AS",-1)),ke={class:"joins"},Ue=y(()=>s("em",null,"INNER JOIN",-1)),xe=y(()=>s("em",null,"ON",-1)),Ie=y(()=>s("span",null,"#",-1)),Le={class:"join-ons"},De=y(()=>s("span",null,".",-1)),Ne=y(()=>s("span",null,"=",-1)),Re=y(()=>s("span",null,".",-1));function je(t,e,l,_,o,n){const d=b("el-button"),c=b("SQLLine"),m=b("DynamicWidthInput");return r(),h("div",{class:x(["table-setting",{visible:l.table!=null}])},[s("div",ue,[i(d,{ico:"Edit",onClick:n.edit},{default:g(()=>[k("Edit")]),_:1},8,["onClick"]),i(d,{type:"primary"},{default:g(()=>[k("Execute")]),_:1})]),l.table!=null?(r(),h("div",ce,[i(c,{type:"select","onField:create":n.createVirtualField},{default:g(()=>[me]),_:1},8,["onField:create"]),(r(!0),h(V,null,w(l.table.fields,(a,f)=>(r(),h(V,null,[n.getAggregate(a)?(r(),h(V,{key:0},[i(c,{indent:"20",visible:a.visible},{default:g(()=>[k("(")]),_:2},1032,["visible"]),i(c,{indent:"40",visible:a.visible},{default:g(()=>[he]),_:2},1032,["visible"]),i(c,{indent:"60",visible:a.visible},{default:g(()=>[i(m,{modelValue:n.getAggregate(a).function,"onUpdate:modelValue":u=>n.getAggregate(a).function=u},null,8,["modelValue","onUpdate:modelValue"]),ge,i(m,{modelValue:n.getAggregate(a).targetTable.alias,"onUpdate:modelValue":u=>n.getAggregate(a).targetTable.alias=u},null,8,["modelValue","onUpdate:modelValue"]),_e,s("span",null,T(n.getAggregate(a).targetField.name),1),be]),_:2},1032,["visible"]),i(c,{indent:"40",visible:a.visible},{default:g(()=>[fe,s("span",null,T(n.getAggregate(a).targetTable.name),1),i(m,{modelValue:n.getAggregate(a).targetTable.alias,"onUpdate:modelValue":u=>n.getAggregate(a).targetTable.alias=u},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["visible"]),i(c,{indent:"20",type:a.isVirtual?"virtual-field":"field",visible:a.visible,"onUpdate:visible":u=>a.visible=u,"onField:delete":u=>n.deleteVirtualField(f)},{default:g(()=>[pe,ye,i(m,{modelValue:a.alias,"onUpdate:modelValue":u=>a.alias=u},null,8,["modelValue","onUpdate:modelValue"]),s("span",null,T(l.table.fields.length===f+1?"":","),1),a.isVirtual?(r(),h(V,{key:0},[ve,i(m,{modelValue:a.type,"onUpdate:modelValue":u=>a.type=u,class:"comment"},null,8,["modelValue","onUpdate:modelValue"]),i(m,{modelValue:a.comment,"onUpdate:modelValue":u=>a.comment=u,class:"comment"},null,8,["modelValue","onUpdate:modelValue"])],64)):C("",!0)]),_:2},1032,["type","visible","onUpdate:visible","onField:delete"])],64)):(r(),M(c,{key:a.name,type:a.isVirtual?"virtual-field":"field",visible:a.visible,"onUpdate:visible":u=>a.visible=u,indent:"20","onField:delete":u=>n.deleteVirtualField(f)},{default:g(()=>[i(m,{modelValue:l.table.alias,"onUpdate:modelValue":e[0]||(e[0]=u=>l.table.alias=u)},null,8,["modelValue"]),Ve,a.isVirtual?(r(),h(V,{key:1},[i(m,{modelValue:a.name,"onUpdate:modelValue":u=>a.name=u},null,8,["modelValue","onUpdate:modelValue"]),Me,i(m,{modelValue:a.name,"onUpdate:modelValue":u=>a.name=u},null,8,["modelValue","onUpdate:modelValue"]),s("span",null,T(l.table.fields.length===f+1?"":","),1),Ce,i(m,{modelValue:a.type,"onUpdate:modelValue":u=>a.type=u,class:"comment"},null,8,["modelValue","onUpdate:modelValue"]),i(m,{modelValue:a.comment,"onUpdate:modelValue":u=>a.comment=u,class:"comment"},null,8,["modelValue","onUpdate:modelValue"])],64)):(r(),h(V,{key:0},[s("span",null,T(a.name),1),Te,i(m,{modelValue:a.alias,"onUpdate:modelValue":u=>a.alias=u},null,8,["modelValue","onUpdate:modelValue"]),s("span",null,T(l.table.fields.length===f+1?"":","),1)],64))]),_:2},1032,["type","visible","onUpdate:visible","onField:delete"]))],64))),256)),l.table.isVirtual?C("",!0):(r(),M(c,{key:0},{default:g(()=>[we,s("span",null,T(l.table.name),1),Fe,i(m,{modelValue:l.table.alias,"onUpdate:modelValue":e[1]||(e[1]=a=>l.table.alias=a)},null,8,["modelValue"])]),_:1})),s("ul",ke,[(r(!0),h(V,null,w(l.tableJoins,a=>(r(),h("li",null,[i(c,{class:"sql-line"},{default:g(()=>[Ue,s("span",null,T(a.joinTable.name),1),i(m,{modelValue:a.joinTable.alias,"onUpdate:modelValue":f=>a.joinTable.alias=f},null,8,["modelValue","onUpdate:modelValue"]),xe,Ie,i(m,{modelValue:a.relation,"onUpdate:modelValue":f=>a.relation=f,class:"comment"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),s("ul",Le,[(r(!0),h(V,null,w(a.ons,(f,u)=>(r(),M(c,{indent:"20"},{default:g(()=>[u!==0?(r(),M(m,{key:0,modelValue:f.relation,"onUpdate:modelValue":v=>f.relation=v},null,8,["modelValue","onUpdate:modelValue"])):C("",!0),i(m,{modelValue:l.table.alias,"onUpdate:modelValue":e[2]||(e[2]=v=>l.table.alias=v)},null,8,["modelValue"]),De,s("span",null,T(f.startField.name),1),Ne,i(m,{modelValue:a.joinTable.alias,"onUpdate:modelValue":v=>a.joinTable.alias=v},null,8,["modelValue","onUpdate:modelValue"]),Re,s("span",null,T(f.endField.name),1)]),_:2},1024))),256))])]))),256))])])):C("",!0)],2)}const Se=F(de,[["render",je],["__scopeId","data-v-a542a2a6"]]);const Ae={name:"QueryModelDesigner",components:{Table:A,RelationLine:q},props:{model:{},fieldHeight:{default:30}},data(){return{rendered:!0,configKonva:{width:1260,height:1e3,draggable:!0},relationLines:[],relationRuntime:{startTable:null,startField:null,endTable:null,endField:null},virtualTable:{name:"test",alias:"test",comment:"",fields:[{name:"regisCount",type:"int",comment:"注册数"}]}}},watch:{model(){this.render()}},methods:{globalClick(t){t.target.nodeType==="Stage"&&(this.model.selectedTableId=null)},moveTable(){for(const t of this.model.tables){const e=this.$refs[t.id][0].getNode().getAbsolutePosition();t.x=e.x,t.y=e.y}this.computeRelations()},computeRelations(){this.relationLines=[];for(const t of this.model.joins)for(const e of t.ons){const l=this.__getFieldPosition(t.table,e.startField),_=this.__getFieldPosition(t.joinTable,e.endField,!1);this.relationLines.push({start:l,end:_,type:"join"})}for(const t of this.model.aggregates){const e=this.__getFieldPosition(t.table,t.field),l=this.__getFieldPosition(t.targetTable,t.targetField,!1);this.relationLines.push({start:e,end:l,type:"aggregate"})}},handleFieldMouseDown({table:t,field:e}){this.$refs.stage.getNode().draggable(!1),this.relationRuntime.startTable=t,this.relationRuntime.startField=e},handleFieldMouseUp({table:t,field:e}){if(this.$refs.stage.getNode().draggable(!0),this.relationRuntime.endTable=t,this.relationRuntime.endField=e,this.relationRuntime.startTable.id!==this.relationRuntime.endTable.id){if(this.model.lineType==="join"){this.__addJoinRelation(),this.$emit("change");return}this.model.lineType==="aggregate"&&(this.__addAggregate(),this.$emit("change"))}},handleTableSelect(t){this.model.selectedTableId=t},handleDrop(t){const e=this.$refs.stage.getNode();e.setPointersPositions(t);const l=e.getPointerPosition(),_={...this.model.dragData,fields:this.model.dragData.fields.map(o=>({...o,alias:o.name})),isVirtual:!1,type:this.model.tables.length===0?"MAIN":"SUB",x:l.x-size.width/2,y:l.y-size.height/2,id:""+Math.random(),joins:[]};this.model.tables.push(_),this.render(),this.$emit("change")},confirmCreateVirtualTable(){const t={width:200,height:(this.virtualTable.fields.length+1)*this.fieldHeight},e={...this.virtualTable,...t,isVirtual:!0,type:this.model.tables.length===0?"MAIN":"SUB",x:100,y:100,id:""+Math.random(),joins:[]};this.model.tables.push(e),this.render(),this.$emit("change")},render(){this.rendered=!1,this.$nextTick(()=>{this.rendered=!0,this.$nextTick(()=>{const e=this.$refs.stage.getNode().container();e.addEventListener("dragover",function(l){l.preventDefault()}),e.addEventListener("drop",l=>{l.preventDefault(),this.handleDrop(l)}),this.computeRelations()})})},__addJoinRelation(){if(this.relationRuntime.startTable.id===this.relationRuntime.endTable.id)return;let t=this.model.joins.find(e=>e.table.id===this.relationRuntime.startTable.id&&e.joinTable.id===this.relationRuntime.endTable.id);t==null&&(t={table:this.relationRuntime.startTable,joinTable:this.relationRuntime.endTable,joinType:"INNER JOIN",relation:"ONE-TO-ONE",ons:[]},this.model.joins.push(t)),t.ons.push({startField:this.relationRuntime.startField,endField:this.relationRuntime.endField,relation:"AND"}),this.computeRelations()},__addAggregate(){if(this.relationRuntime.startTable.id===this.relationRuntime.endTable.id)return;let t=this.model.aggregates.find(e=>e.table.id===this.relationRuntime.startTable.id&&e.targetTable.id===this.relationRuntime.endTable.id);t==null&&(t={table:this.relationRuntime.startTable,targetTable:this.relationRuntime.endTable,field:this.relationRuntime.startField,targetField:this.relationRuntime.endField,function:"COUNT"},this.model.aggregates.push(t)),this.computeRelations()},__getFieldPosition(t,e,l=!0){const o=this.$refs.stage.getNode().getAbsolutePosition(),n=t.fields.findIndex(m=>m.name===e.name),d=t.x+(l?200:0)-o.x,c=t.y+this.fieldHeight+(n+1)*this.fieldHeight-15-o.y;return{x:d,y:c}}},mounted(){this.render()}},qe=t=>(L("data-v-01967e25"),t=t(),D(),t),He={class:"wrap"},Pe=qe(()=>s("p",null,"Drag and drop the table on the left here or fill out the form below to create a virtual table.",-1)),Ee={class:"opera"};function $e(t,e,l,_,o,n){const d=b("el-input"),c=b("el-table-column"),m=b("el-table"),a=b("el-button"),f=b("Table"),u=b("RelationLine"),v=b("v-layer"),I=b("v-stage");return r(),h(V,null,[l.model.tables.length===0?(r(),h("div",{key:0,class:"empty-tip",onDragover:e[0]||(e[0]=$(()=>{},["prevent"])),onDrop:e[1]||(e[1]=(...p)=>n.handleDrop&&n.handleDrop(...p))},[s("div",He,[Pe,i(m,{data:o.virtualTable.fields},{default:g(()=>[i(c,{prop:"name",label:"*Name"},{default:g(({row:p})=>[i(d,{modelValue:p.name,"onUpdate:modelValue":U=>p.name=U},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(c,{prop:"type",label:"*Type"},{default:g(({row:p})=>[i(d,{modelValue:p.type,"onUpdate:modelValue":U=>p.type=U},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(c,{prop:"comment",label:"*Comment"},{default:g(({row:p})=>[i(d,{modelValue:p.comment,"onUpdate:modelValue":U=>p.comment=U},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"]),s("div",Ee,[i(a,{type:"important",onClick:n.confirmCreateVirtualTable},{default:g(()=>[k("Confirm Create")]),_:1},8,["onClick"])])])],32)):C("",!0),o.rendered?(r(),M(I,{key:1,ref:"stage",config:o.configKonva,onMouseup:e[2]||(e[2]=p=>t.$refs.stage.getNode().draggable(!0)),onClick:n.globalClick},{default:g(()=>[(r(!0),h(V,null,w(l.model.tables,p=>(r(),M(f,{ref_for:!0,ref:p.id,key:p.name,"field-height":l.fieldHeight,x:p.x,y:p.y,table:p,relations:l.model.joins,selected:l.model.selectedTableId===p.id,onDragmove:n.moveTable,"onField:mousedown":n.handleFieldMouseDown,"onField:mouseup":n.handleFieldMouseUp,"onTable:select":n.handleTableSelect},null,8,["field-height","x","y","table","relations","selected","onDragmove","onField:mousedown","onField:mouseup","onTable:select"]))),128)),i(v,null,{default:g(()=>[(r(!0),h(V,null,w(o.relationLines,p=>(r(),M(u,{"line-type":p.type,start:p.start,end:p.end},null,8,["line-type","start","end"]))),256))]),_:1})]),_:1},8,["config","onClick"])):C("",!0)],64)}const We=F(Ae,[["render",$e],["__scopeId","data-v-01967e25"]]);const Qe={name:"TableLibrary",components:{InnerRouterView:z,InnerRouterViewWindow:J},props:{queryModels:{required:!0},tables:{},currentModel:{}},data(){return{newModel:{name:"",comment:""}}},methods:{handleDragStart(t){this.$emit("table:drag",t.target.getAttribute("name"))},createQueryModel(){this.$refs.routerViewWindow.push("create-model")},confirmCreate(){this.queryModels.push({...this.newModel,lineType:"join",tables:[],joins:[],aggregates:[],selectedTableId:null,dragData:null}),this.selectModel(this.queryModels[this.queryModels.length-1]),this.$refs.routerViewWindow.back()},selectModel(t){this.$emit("update:currentModel",t)}}},H=t=>(L("data-v-1bf17840"),t=t(),D(),t),Oe={class:"table-library"},ze={class:"block"},Je={class:"header",slot:"title"},Be=H(()=>s("h4",null,"Query Models",-1)),Ke=["onClick"],Ge={class:"create-model-form"},Xe={class:"opera"},Ye={class:"block"},Ze=H(()=>s("div",{class:"header"},[s("h4",null,"Tables")],-1)),et=["name"];function tt(t,e,l,_,o,n){const d=b("el-button"),c=b("InnerRouterView"),m=b("el-input"),a=b("el-form-item"),f=b("el-form"),u=b("InnerRouterViewWindow");return r(),h("div",Oe,[s("div",ze,[i(u,{ref:"routerViewWindow",default:"query-models"},{default:g(()=>[i(c,{name:"query-models"},{default:g(()=>[s("div",Je,[Be,i(d,{type:"primary",icon:"Plus",class:"button-icon",onClick:n.createQueryModel},null,8,["onClick"])]),s("ul",null,[(r(!0),h(V,null,w(l.queryModels,v=>(r(),h("li",{key:v.name,class:x({selected:l.currentModel!=null&&l.currentModel.name===v.name}),onClick:I=>n.selectModel(v)},T(v.name),11,Ke))),128))])]),_:1}),i(c,{name:"create-model",title:"Create New Model"},{default:g(()=>[s("div",Ge,[i(f,{model:o.newModel},{default:g(()=>[i(a,{label:"Model Name",required:""},{default:g(()=>[i(m,{modelValue:o.newModel.name,"onUpdate:modelValue":e[0]||(e[0]=v=>o.newModel.name=v)},null,8,["modelValue"])]),_:1}),i(a,{label:"Comment",required:""},{default:g(()=>[i(m,{modelValue:o.newModel.comment,"onUpdate:modelValue":e[1]||(e[1]=v=>o.newModel.comment=v),type:"textarea",rows:2},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),s("div",Xe,[i(d,null,{default:g(()=>[k("Cancel")]),_:1}),i(d,{type:"primary",onClick:n.confirmCreate},{default:g(()=>[k("Confirm")]),_:1},8,["onClick"])])])]),_:1})]),_:1},512)]),s("div",Ye,[Ze,s("ul",null,[(r(!0),h(V,null,w(l.tables,v=>(r(),h("li",{key:v.name,name:v.name,draggable:"true",onDragstart:e[2]||(e[2]=(...I)=>n.handleDragStart&&n.handleDragStart(...I))},T(v.name),41,et))),128))])])])}const lt=F(Qe,[["render",tt],["__scopeId","data-v-1bf17840"]]);const nt={components:{TableLibrary:lt,QueryModelDesigner:We,TableSetting:Se,RelationLine:q,Table:A},data(){return{fieldHeight:30,queryModels:[],tables:[],lineType:"join",currentModel:null}},computed:{...W(["currentProject","currentDatabase"]),currentTable(){return this.currentModel==null||this.currentModel.selectedTableId==null?null:this.currentModel.tables.find(t=>t.id===this.currentModel.selectedTableId)},currentTableJoins(){return this.currentTable==null||this.currentTable.type!=="MAIN"?[]:this.currentModel.joins.filter(t=>t.table.id===this.currentTable.id||t.joinTable.id===this.currentTable.id)},currentTableAggregates(){return this.currentTable==null||this.currentTable.type!=="MAIN"?[]:this.currentModel.aggregates.filter(t=>t.table.id===this.currentTable.id)}},methods:{saveModel(){const t={name:this.currentModel.name,comment:this.currentModel.comment,tables:this.currentModel.tables.map(e=>({name:e.name,alias:e.alias,isVirtual:e.isVirtual,type:e.type,fields:e.fields.map(l=>({name:l.name,alias:l.alias,type:l.type,comment:l.comment,isVirtual:l.isVirtual})),x:e.x,y:e.y})),joins:this.currentModel.joins.map(e=>({...e,table:e.table.name,joinTable:e.joinTable.name,ons:e.ons.map(l=>({startField:l.startField.name,endField:l.endField.name,relation:l.relation}))})),aggregates:this.currentModel.aggregates.map(e=>({table:e.table.name,targetTable:e.targetTable.name,field:e.field.name,targetField:e.targetField.name,function:e.function}))};Q({projectId:this.currentProject.id,database:this.currentDatabase,model:t}).then(()=>{console.log("保存成功")}).catch(e=>{this.$tip.apiFailed(e)})},handleSettingChange(){this.saveModel(),this.$refs.designer.render()},handleDragStart(t){this.currentModel.dragData=this.tables.find(e=>e.name===t)},fetchTables(){const t=this.currentProject.databases.find(e=>e.name===this.currentDatabase);O({host:t.host,port:t.port,user:t.username,password:t.password,database:t.schema}).then(e=>{this.tables=e.map(l=>({...l,alias:l.name,fields:l.fields.map(_=>({..._,isVirtual:!1}))})),this.fetchModels()}).catch(e=>{this.$tip.apiFailed(e)})},fetchModels(){console.log(this.currentProject.databases);const t=this.currentProject.databases.find(e=>e.name===this.currentDatabase).models;this.queryModels=t.map(e=>(e.tables=e.tables.map(l=>{const _=this.tables.find(n=>n.name.toLowerCase()===l.name.toLowerCase());if(_==null)return null;const o=_.fields.map(n=>{const d=l.fields.find(c=>c.name===n.name);return this.__modelField2field(d,n)});return{id:""+Math.random(),...l,fields:o,joins:[]}}),e.tables=e.tables.filter(l=>l!=null),e.tables.length===0?null:(e.joins.map(l=>this.__modelJoin2join(e,l)),e.joins=e.joins.filter(l=>l!=null),e.aggregates.map(l=>this.__modelAggregate2Aggregate(e,l)),e.aggregates=e.aggregates.filter(l=>l!=null),e))),this.queryModels=this.queryModels.filter(e=>e!=null)},__modelField2field(t,e){return e!=null&&t==null?{...e,visible:!1,alias:e.name,isVirtual:!1}:e==null?null:{...e,alias:t.alias,isVirtual:t.isVirtual,type:t.isVirtual?t.type:e.type,comment:t.isVirtual?t.comment:e.comment,visible:!0}},__modelJoin2join(t,e){const l=t.tables.find(n=>n.name.toLowerCase()===e.table.toLowerCase()),_=t.tables.find(n=>n.name.toLowerCase()===e.joinTable.toLowerCase());if(l==null||_==null)return null;e.table=l,e.joinTable=_;const o=[];for(const n of e.ons){const d=l.fields.find(m=>m.name.toLowerCase()===n.startField.toLowerCase()),c=_.fields.find(m=>m.name.toLowerCase()===n.endField.toLowerCase());d==null||c==null||o.push({startField:d,endField:c,relation:n.relation})}return o.length===0?null:(e.ons=o,e)},__modelAggregate2Aggregate(t,e){const l=t.tables.find(d=>d.name.toLowerCase()===e.table.toLowerCase()),_=t.tables.find(d=>d.name.toLowerCase()===e.targetTable.toLowerCase());if(l==null||_==null)return null;e.table=l,e.targetTable=_;const o=l.fields.find(d=>d.name.toLowerCase()===e.field.toLowerCase()),n=_.fields.find(d=>d.name.toLowerCase()===e.targetField.toLowerCase());return o==null||n==null?null:(e.field=o,e.targetField=n,e)}},created(){this.fetchTables()}},N=t=>(L("data-v-e21561b0"),t=t(),D(),t),at={class:"database-query-models"},st={class:"designer-wrap"},it={key:0,class:"line-types"},ot=N(()=>s("em",{class:"join-line"},null,-1)),rt=N(()=>s("label",null,"Join Line",-1)),dt=[ot,rt],ut=N(()=>s("em",{class:"aggregate-line"},null,-1)),ct=N(()=>s("label",null,"Aggregate Line",-1)),mt=[ut,ct];function ht(t,e,l,_,o,n){const d=b("TableLibrary"),c=b("QueryModelDesigner"),m=b("TableSetting");return r(),h("div",at,[i(d,{"query-models":o.queryModels,tables:o.tables,"onTable:drag":n.handleDragStart,"current-model":o.currentModel,"onUpdate:currentModel":e[0]||(e[0]=a=>o.currentModel=a)},null,8,["query-models","tables","onTable:drag","current-model"]),s("div",st,[o.currentModel!=null?(r(),h("ul",it,[s("li",{class:x({selected:o.currentModel.lineType==="join"}),onClick:e[1]||(e[1]=a=>o.currentModel.lineType="join")},dt,2),s("li",{class:x({selected:o.currentModel.lineType==="aggregate"}),onClick:e[2]||(e[2]=a=>o.currentModel.lineType="aggregate")},mt,2)])):C("",!0),o.currentModel!=null?(r(),M(c,{key:1,ref:"designer",model:o.currentModel,"field-height":30,onChange:n.saveModel},null,8,["model","onChange"])):C("",!0)]),i(m,{table:n.currentTable,"table-joins":n.currentTableJoins,aggregates:n.currentTableAggregates,"onField:change":n.handleSettingChange},null,8,["table","table-joins","aggregates","onField:change"])])}const bt=F(nt,[["render",ht],["__scopeId","data-v-e21561b0"]]);export{bt as default};
