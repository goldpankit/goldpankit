import{_ as F,r as f,o as u,g as M,w as g,b as d,c as b,f as k,F as V,a as s,K as B,A as R,I as $,j as w,H as L,a0 as j,t as y,m as A,a1 as J,a2 as K,e as I,p as P,l as O,i as U,x as z,a3 as H,a4 as G,a5 as X,D as Y,Z}from"./index-1dacb25b.js";import{g as D}from"./generator-85abd6da.js";import{a as ee,I as te}from"./InnerRouterViewWindow-37baf67e.js";import{b as q}from"./form.check-189b470c.js";const le={name:"Table",props:{x:{default:0},y:{default:0},fieldHeight:{default:30},table:{required:!0},relations:{required:!0},selected:{default:!1}},data(){const e=this;return{layerConfig:{x:e.x,y:e.y,draggable:!1}}},computed:{backgroundConfig(){return{width:200,height:(this.visibleFields.length+1)*this.fieldHeight,fill:"#fafafa"}},tableNameConfig(){return{text:this.table.name,x:10,y:8,fontSize:15,fill:"#fff"}},tableHeaderConfig(){return{width:200,height:this.fieldHeight,fill:this.table.type==="MAIN"?"#FC777D":"#666"}},relation(){return this.relations.find(e=>e.targetTable===this.table.name)},visibleFields(){return this.table.fields.filter(e=>e.visible===!0)}},watch:{selected(e){if(e){this.select();return}this.select(!1)}},methods:{selectTable(e){this.$emit("table:select",this.table.id)},previewTable(e){this.$emit("table:preview",this.table.id)},select(e=!0){const t=this.$refs.background.getNode();e?(t.setAttr("stroke",(this.table.type==="MAIN","#FC777D")),t.setAttr("strokeWidth",5)):t.setAttr("strokeWidth",0)},handleHeaderMouseover(e){this.getNode().draggable(!0),window.document.body.style.cursor="move"},handleHeaderMouseleave(e){this.getNode().draggable(!1),window.document.body.style.cursor="default"},getNode(){return this.$refs.table.getNode()},handleFieldMouseDown(e){this.getNode().draggable(!1),this.$emit("field:mousedown",{table:this.table,field:e})},handleFieldMouseUp(e){this.getNode().draggable(!0),this.$emit("field:mouseup",{table:this.table,field:e})}}};function ne(e,t,l,o,a,n){const r=f("v-rect"),c=f("v-text"),p=f("v-layer");return u(),M(p,{ref:"table",config:a.layerConfig},{default:g(()=>[d(r,{ref:"background",config:n.backgroundConfig},null,8,["config"]),d(r,{config:n.tableHeaderConfig,onMouseover:n.handleHeaderMouseover,onMouseleave:n.handleHeaderMouseleave,onClick:n.selectTable,onDblclick:n.previewTable},null,8,["config","onMouseover","onMouseleave","onClick","onDblclick"]),d(c,{config:n.tableNameConfig,onMouseover:n.handleHeaderMouseover,onMouseleave:n.handleHeaderMouseleave,onClick:n.selectTable,onDblclick:n.previewTable},null,8,["config","onMouseover","onMouseleave","onClick","onDblclick"]),(u(!0),b(V,null,k(n.visibleFields,(h,_)=>(u(),M(r,{key:h.name,config:{y:_*l.fieldHeight+n.tableHeaderConfig.height,width:200,height:l.fieldHeight,fill:"#fff"},onMousedown:i=>n.handleFieldMouseDown(h),onMouseup:i=>n.handleFieldMouseUp(h)},null,8,["config","onMousedown","onMouseup"]))),128)),(u(!0),b(V,null,k(n.visibleFields,(h,_)=>(u(),M(c,{key:h,config:{text:h.name,x:10,y:_*l.fieldHeight+n.tableHeaderConfig.height+10,fontSize:13,fill:"#333"},onMousedown:i=>n.handleFieldMouseDown(h),onMouseup:i=>n.handleFieldMouseUp(h)},null,8,["config","onMousedown","onMouseup"]))),128))]),_:1},8,["config"])}const W=F(le,[["render",ne]]);const N={join:{color:"#eee",hoverColor:"#faa5aa",selectedColor:"#FC777D"},aggregate:{color:"#9b8e35",hoverColor:"#d9c64b",selectedColor:"#FFE957"}},ae={name:"RelationLine",props:{start:{required:!0},end:{required:!0},selected:{default:!1},lineType:{required:!0}},data(){return{lineConfig:{x:0,y:0,stroke:"#ccc",strokeWidth:4,lineJoin:"round",lineCap:"round"}}},computed:{position(){return[this.start,this.end]}},watch:{position(){this.init()},selected(){this.selected?this.highlight(!0,this.selected):this.highlight(!1,this.selected)}},methods:{handleSelect(){this.selected?this.$emit("unselect"):this.$emit("select")},highlight(e=!0,t=!1){const l=this.$refs.line.getNode();if(e)t?(l.setAttr("stroke",N[this.lineType].selectedColor),l.zIndex(101)):(l.setAttr("stroke",N[this.lineType].hoverColor),l.zIndex(100)),l.setAttr("strokeWidth",5);else{if(l.zIndex(1),t)return;l.setAttr("stroke",N[this.lineType].color),l.setAttr("strokeWidth",4)}},init(){this.lineConfig.stroke=N[this.lineType].color;const e=[];this.start.y!==this.end.y&&(this.end.x-this.start.x>0?this.end.x-this.start.x<50?(this.start.x-=200,e.push(this.start.x-50),e.push(this.start.y),e.push(this.start.x-50),e.push(this.end.y)):(e.push(this.start.x+(this.end.x-this.start.x)/2),e.push(this.start.y),e.push(this.start.x+(this.end.x-this.start.x)/2),e.push(this.end.y)):Math.abs(this.end.x-this.start.x)<200?(this.start.x-=200,e.push(this.start.x-50),e.push(this.start.y),e.push(this.start.x-50),e.push(this.end.y)):Math.abs(this.end.x-this.start.x)<450?(this.end.x+=200,e.push(this.start.x+50),e.push(this.start.y),e.push(this.start.x+50),e.push(this.end.y)):(this.start.x-=200,this.end.x+=200,e.push(this.start.x-Math.abs(this.end.x-this.start.x)/2),e.push(this.start.y),e.push(this.start.x-Math.abs(this.end.x-this.start.x)/2),e.push(this.end.y))),this.lineConfig.points=[this.start.x,this.start.y,...e,this.end.x,this.end.y]}},created(){this.init()}};function ie(e,t,l,o,a,n){const r=f("v-line");return u(),M(r,{ref:"line",config:a.lineConfig,onMouseenter:t[0]||(t[0]=c=>n.highlight(!0,l.selected)),onMouseleave:t[1]||(t[1]=c=>n.highlight(!1,l.selected)),onClick:n.handleSelect},null,8,["config","onClick"])}const E=F(ae,[["render",ie],["__scopeId","data-v-f68765de"]]);const se={name:"SQLLine",props:{type:{},indent:{default:0},visible:{default:!0}}},oe={class:"code"},de={class:"opera"},re={key:0},ue={key:1},he={key:2};function ce(e,t,l,o,a,n){const r=f("el-button");return u(),b("div",{class:L(["sql-line",{"sql-line__hide":!l.visible}]),style:j({"padding-left":l.indent+"px"})},[s("p",oe,[B(e.$slots,"default",{},void 0,!0)]),s("ul",de,[l.type==="field"?(u(),b("li",re,[R(d(r,{icon:"View",onClick:t[0]||(t[0]=c=>e.$emit("update:visible",!1))},null,512),[[$,l.visible]]),R(d(r,{icon:"Hide",onClick:t[1]||(t[1]=c=>e.$emit("update:visible",!0))},null,512),[[$,!l.visible]])])):w("",!0),l.type==="virtual-field"?(u(),b("li",ue,[d(r,{icon:"Delete",onClick:t[2]||(t[2]=c=>e.$emit("field:delete",!1))})])):w("",!0),l.type==="select"?(u(),b("li",he,[d(r,{icon:"Plus",onClick:t[3]||(t[3]=c=>e.$emit("field:create"))})])):w("",!0)])],6)}const me=F(se,[["render",ce],["__scopeId","data-v-e7a08f13"]]);const ge={name:"DynamicWidthInput",props:{modelValue:{}},data(){return{value:this.modelValue}},watch:{modelValue:{immediate:!0,handler(){this.value=this.modelValue}}},methods:{handleInput(e){this.value=e.target.innerText,this.$emit("update:modelValue",e.target.innerText),this.$emit("change",e.target.innerText)},handleBlur(){this.$emit("update:blur-model-value",this.value),this.$emit("blur")}}};function be(e,t,l,o,a,n){return u(),b("div",{class:"dynamic-width-input",contenteditable:!0,onInput:t[0]||(t[0]=(...r)=>n.handleInput&&n.handleInput(...r)),onBlur:t[1]||(t[1]=(...r)=>n.handleBlur&&n.handleBlur(...r))},y(l.modelValue),33)}const fe=F(ge,[["render",be],["__scopeId","data-v-208cca2b"]]);const _e={name:"SQLLineKeywordSelect",props:{data:{type:Array,required:!0}}};function pe(e,t,l,o,a,n){const r=f("el-option"),c=f("el-select");return u(),M(c,null,{default:g(()=>[(u(!0),b(V,null,k(l.data,p=>(u(),M(r,{key:p,value:p,label:p},null,8,["value","label"]))),128))]),_:1})}const ye=F(_e,[["render",pe],["__scopeId","data-v-919f06f3"]]);const ve={name:"SQLPreview",data(){return{visible:!1,result:[]}},computed:{columns(){if(this.result.length===0)return[];const e=[];for(const t in this.result[0])e.push(t);return e},rows(){return this.result}},methods:{open(e){this.visible=!0,this.result=e},getColumnWidth(e){return e.length*15}}};function Te(e,t,l,o,a,n){const r=f("el-table-column"),c=f("el-table"),p=f("el-dialog");return u(),M(p,{"custom-class":"sql-preview",title:"Query Result",modelValue:a.visible,"onUpdate:modelValue":t[0]||(t[0]=h=>a.visible=h),"append-to-body":""},{default:g(()=>[d(c,{data:a.result},{default:g(()=>[(u(!0),b(V,null,k(n.columns,h=>(u(),M(r,{key:h,prop:h,label:h,"min-width":n.getColumnWidth(h)},null,8,["prop","label","min-width"]))),128))]),_:1},8,["data"])]),_:1},8,["modelValue"])}const Ce=F(ve,[["render",Te]]);const Ve={name:"TableSetting",components:{SQLPreview:Ce,SQLLineKeywordSelect:ye,DynamicWidthInput:fe,SQLLine:me},props:{table:{required:!0},tableJoins:{type:Array},aggregates:{type:Array}},computed:{...A(["currentDatabase"]),visibleFields(){let e=new Set;for(const t of this.table.fields)t.table=this.table,t.alias=t.name,e.add(t);for(const t of this.tableJoins){for(const l of t.table.fields)l.table=t.table,l.alias=l.name,e.add(l);for(const l of t.targetTable.fields)l.table=t.targetTable,l.alias=l.name,e.add(l)}return[...e]}},methods:{copy(){J({sql:this.__getSql()}).then(e=>navigator.clipboard.writeText(e)).then(()=>{this.$tip.success("Copy successfully.")}).catch(e=>{this.$tip.apiFailed(e)})},execute(){const e=this.__getSql();K({database:this.currentDatabase,sql:e}).then(t=>{this.$refs.sqlPreview.open(t)}).catch(t=>{this.$tip.apiFailed(t)})},createVirtualField(){this.table.fields.push({name:"virtual1",alias:"virtual1",type:"int",comment:"Virtual field 1",isVirtual:!0,visible:!0}),this.handleChange()},deleteVirtualField(e){this.table.fields.splice(e,1),this.handleChange()},getAggregate(e){const t=this.aggregates.find(l=>l.field.name===e.name);return t??null},fieldVisibleChange(){this.$emit("field:change")},handleChange(){this.$emit("field:change")},__getAggregateFunctionWidth(e){return{COUNT:63,SUM:42,AVG:40,MAX:42,MIN:38}[e]},__getSql(){const e=[];e.push("SELECT");for(const t of this.visibleFields){if(!t.visible)continue;const l=this.getAggregate(t);l!=null?(e.push("(SELECT"),e.push(`${l.function}(${l.targetTable.alias}.${l.targetField.name})`),e.push(`FROM ${l.targetTable.name} AS ${l.targetTable.alias}) AS ${l.field.name},`)):e.push(`${t.table.alias}.${t.name} AS ${t.alias},`)}e[e.length-1]=e[e.length-1].substring(0,e[e.length-1].length-1),this.table.isVirtual||e.push(`FROM ${this.table.name} AS ${this.table.alias}`);for(const t of this.tableJoins){e.push(`${t.joinType} ${t.targetTable.name} ${t.targetTable.alias}`);for(let l=0;l<t.ons.length;l++){const o=t.ons[l];let a=l===0?"ON ":`${o.relation} `;e.push(`${a}${t.targetTable.alias}.${o.targetField.name} = ${t.table.alias}.${o.field.name}`)}}return e.join(`
`)}}},C=e=>(P("data-v-99b7e08b"),e=e(),O(),e),Me={class:"toolbar"},we={key:0,class:"wrap"},ke=C(()=>s("em",null,"SELECT",-1)),Fe=C(()=>s("em",null,"SELECT",-1)),xe={class:"hidden"},Ie=C(()=>s("span",null,"(",-1)),Le=C(()=>s("span",null,".",-1)),Se=C(()=>s("span",null,")",-1)),De=C(()=>s("em",null,"FROM",-1)),Ne=C(()=>s("span",null,")",-1)),Ue=C(()=>s("em",null,"AS",-1)),Ae=C(()=>s("span",{class:"comment"},"#",-1)),Re=C(()=>s("span",null,".",-1)),$e=C(()=>s("em",null,"AS",-1)),qe=C(()=>s("em",null,"AS",-1)),je=C(()=>s("span",{class:"comment"},"#",-1)),Pe=C(()=>s("em",null,"FROM",-1)),Oe=C(()=>s("em",null,"AS",-1)),He={class:"joins"},We={class:"hidden"},Ee=C(()=>s("em",null,"ON",-1)),Qe={class:"join-ons"},Be=C(()=>s("span",null,".",-1)),Je=C(()=>s("span",null,"=",-1)),Ke=C(()=>s("span",null,".",-1));function ze(e,t,l,o,a,n){const r=f("el-button"),c=f("SQLLine"),p=f("SQLLineKeywordSelect"),h=f("DynamicWidthInput"),_=f("SQLPreview");return u(),b("div",{class:L(["table-setting",{visible:l.table!=null}])},[s("div",Me,[d(r,{type:"primary",class:"button-copy","data-clipboard-text":"Hello World",onClick:n.copy},{default:g(()=>[I(y(e.$t("common.copy")),1)]),_:1},8,["onClick"]),d(r,{type:"primary",onClick:n.execute},{default:g(()=>[I(y(e.$t("common.execute")),1)]),_:1},8,["onClick"])]),l.table!=null?(u(),b("div",we,[d(c,{type:"select","onField:create":n.createVirtualField},{default:g(()=>[ke]),_:1},8,["onField:create"]),(u(!0),b(V,null,k(n.visibleFields,(i,v)=>(u(),b(V,null,[n.getAggregate(i)?(u(),b(V,{key:0},[d(c,{indent:"20",visible:i.visible},{default:g(()=>[I("(")]),_:2},1032,["visible"]),d(c,{indent:"40",visible:i.visible},{default:g(()=>[Fe]),_:2},1032,["visible"]),d(c,{indent:"60",visible:i.visible},{default:g(()=>[d(p,{modelValue:n.getAggregate(i).function,"onUpdate:modelValue":m=>n.getAggregate(i).function=m,data:["COUNT","SUM","AVG","MAX","MIN"],style:j(`width: ${n.__getAggregateFunctionWidth(n.getAggregate(i).function)}px;`),onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","style","onChange"]),s("span",xe,y(n.getAggregate(i).function),1),Ie,d(h,{modelValue:n.getAggregate(i).targetTable.alias,"onUpdate:modelValue":m=>n.getAggregate(i).targetTable.alias=m,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),Le,s("span",null,y(n.getAggregate(i).targetField.name),1),Se]),_:2},1032,["visible"]),d(c,{indent:"40",visible:i.visible},{default:g(()=>[De,s("span",null,y(n.getAggregate(i).targetTable.name),1),d(h,{modelValue:n.getAggregate(i).targetTable.alias,"onUpdate:modelValue":m=>n.getAggregate(i).targetTable.alias=m,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["visible"]),d(c,{indent:"20",type:i.isVirtual?"virtual-field":"field",visible:i.visible,"onUpdate:visible":[m=>i.visible=m,n.fieldVisibleChange],"onField:delete":m=>n.deleteVirtualField(v)},{default:g(()=>[Ne,Ue,d(h,{modelValue:i.alias,"onUpdate:modelValue":m=>i.alias=m},null,8,["modelValue","onUpdate:modelValue"]),s("span",null,y(n.visibleFields.length===v+1?"":","),1),i.isVirtual?(u(),b(V,{key:0},[Ae,d(h,{modelValue:i.type,"onUpdate:modelValue":m=>i.type=m,class:"comment",onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),d(h,{modelValue:i.comment,"onUpdate:modelValue":m=>i.comment=m,class:"comment",onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"])],64)):w("",!0)]),_:2},1032,["type","visible","onUpdate:visible","onField:delete"])],64)):(u(),M(c,{key:i.name,type:i.isVirtual?"virtual-field":"field",visible:i.visible,"onUpdate:visible":[m=>i.visible=m,n.fieldVisibleChange],indent:"20","onField:delete":m=>n.deleteVirtualField(v)},{default:g(()=>[d(h,{modelValue:i.table.alias,"onUpdate:modelValue":m=>i.table.alias=m,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),Re,i.isVirtual?(u(),b(V,{key:1},[d(h,{"model-value":i.name,"blur-model-value":i.name,"onUpdate:blurModelValue":m=>i.name=m,onBlur:n.handleChange},null,8,["model-value","blur-model-value","onUpdate:blurModelValue","onBlur"]),qe,d(h,{"model-value":i.alias,"blur-model-value":i.alias,"onUpdate:blurModelValue":m=>i.alias=m,onBlur:n.handleChange},null,8,["model-value","blur-model-value","onUpdate:blurModelValue","onBlur"]),s("span",null,y(n.visibleFields.length===v+1?"":","),1),je,d(h,{modelValue:i.type,"onUpdate:modelValue":m=>i.type=m,class:"comment",onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),d(h,{modelValue:i.comment,"onUpdate:modelValue":m=>i.comment=m,class:"comment",onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"])],64)):(u(),b(V,{key:0},[s("span",null,y(i.name),1),$e,d(h,{modelValue:i.alias,"onUpdate:modelValue":m=>i.alias=m,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),s("span",null,y(n.visibleFields.length===v+1?"":","),1)],64))]),_:2},1032,["type","visible","onUpdate:visible","onField:delete"]))],64))),256)),l.table.isVirtual?w("",!0):(u(),M(c,{key:0},{default:g(()=>[Pe,s("span",null,y(l.table.name),1),Oe,d(h,{modelValue:l.table.alias,"onUpdate:modelValue":t[0]||(t[0]=i=>l.table.alias=i),onChange:n.handleChange},null,8,["modelValue","onChange"])]),_:1})),s("ul",He,[(u(!0),b(V,null,k(l.tableJoins,i=>(u(),b("li",null,[d(c,null,{default:g(()=>[d(p,{modelValue:i.joinType,"onUpdate:modelValue":v=>i.joinType=v,data:["INNER JOIN","LEFT JOIN","RIGHT JOIN","OUTER JOIN"],class:"keyword",style:{width:"100px"},onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),s("span",We,y(i.joinType),1),s("span",null,y(i.targetTable.name),1),d(h,{modelValue:i.targetTable.alias,"onUpdate:modelValue":v=>i.targetTable.alias=v,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),Ee,d(p,{modelValue:i.relation,"onUpdate:modelValue":v=>i.relation=v,data:["ONE-TO-ONE","ONE-TO-MANY","MANY-TO-ONE"],class:"relation",style:{width:"115px"},onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024),s("ul",Qe,[(u(!0),b(V,null,k(i.ons,(v,m)=>(u(),M(c,{indent:"20"},{default:g(()=>[m!==0?(u(),M(p,{key:0,modelValue:v.relation,"onUpdate:modelValue":x=>v.relation=x,data:["AND","OR"],style:{width:"40px"},onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"])):w("",!0),d(h,{modelValue:i.targetTable.alias,"onUpdate:modelValue":x=>i.targetTable.alias=x,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),Be,s("span",null,y(v.targetField.name),1),Je,d(h,{modelValue:i.table.alias,"onUpdate:modelValue":x=>i.table.alias=x,onChange:n.handleChange},null,8,["modelValue","onUpdate:modelValue","onChange"]),Ke,s("span",null,y(v.field.name),1)]),_:2},1024))),256))])]))),256))])])):w("",!0),d(_,{ref:"sqlPreview"},null,512)],2)}const Ge=F(Ve,[["render",ze],["__scopeId","data-v-99b7e08b"]]);const Xe={name:"QueryModelDesigner",components:{Table:W,RelationLine:E},props:{model:{},fieldHeight:{default:30}},data(){return{rendered:!0,configKonva:{width:1260,height:1e3,draggable:!0},relationLines:[],relationRuntime:{table:null,field:null,targetTable:null,targetField:null}}},computed:{tableLength(){return this.model.tables.length}},watch:{tableLength(){this.render()},model(){this.render()}},methods:{handleDelete(){if(this.model.selectedLineId!=null){this.__deleteLine();return}this.model.selectedTableId!=null&&this.__deleteTable()},globalClick(e){e.target.nodeType==="Stage"&&(this.model.selectedTableId=null,this.model.previewTableId=null,this.model.selectedLineId=null)},moveTable(){for(const e of this.model.tables){const t=this.$refs[e.id][0].getNode().getAbsolutePosition();e.x=t.x,e.y=t.y}this.computeRelations()},computeRelations(){this.relationLines=[];for(const e of this.model.joins){const t=this.model.tables.find(o=>o.id===e.table.id),l=this.model.tables.find(o=>o.id===e.targetTable.id);for(const o of e.ons){const a=this.__getFieldPosition(t,o.field),n=this.__getFieldPosition(l,o.targetField,!1);a==null||n==null||this.relationLines.push({id:D(),start:a,end:n,type:"join",table:e.table,field:o.field,targetTable:e.targetTable,targetField:o.targetField})}}for(const e of this.model.aggregates){const t=this.__getFieldPosition(e.table,e.field),l=this.__getFieldPosition(e.targetTable,e.targetField,!1);t==null||l==null||this.relationLines.push({id:D(),start:t,end:l,type:"aggregate",table:e.table,field:e.field,targetTable:e.targetTable,targetField:e.targetField})}},handleFieldMouseDown({table:e,field:t}){this.$refs.stage.getNode().draggable(!1),this.relationRuntime.table=e,this.relationRuntime.field=t},handleFieldMouseUp({table:e,field:t}){if(this.$refs.stage.getNode().draggable(!0),this.relationRuntime.targetTable=e,this.relationRuntime.targetField=t,this.relationRuntime.table.id!==this.relationRuntime.targetTable.id){if(this.model.lineType==="join"){this.__addJoinRelation(),this.$emit("change");return}this.model.lineType==="aggregate"&&(this.__addAggregate(),this.$emit("change"))}},handleTableSelect(e){this.model.selectedTableId=e,this.model.selectedLineId=null,this.model.previewTableId=null},handleLineSelect(e){this.model.selectedLineId=e.id,this.model.selectedTableId=null,this.model.previewTableId=null},handleTablePreview(e){this.model.previewTableId=e},handleDrop(e){const t=this.$refs.stage.getNode();t.setPointersPositions(e);const l=t.getPointerPosition(),o={width:200,height:(this.model.dragData.fields.length+1)*this.fieldHeight},a={...this.model.dragData,fields:this.model.dragData.fields.map(n=>({...n,alias:n.name,visible:!0,isVirtual:!1})),isVirtual:!1,type:this.model.tables.length===0?"MAIN":"SUB",x:l.x-o.width/2,y:l.y-o.height/2,id:D(),joins:[]};this.model.tables.push(a),this.render(),this.$emit("change")},confirmCreateVirtualTable(){const e={width:200,height:this.fieldHeight},t={id:D(),name:this.model.name,alias:this.model.name,comment:this.model.comment,...e,type:"MAIN",isVirtual:!0,fields:[],x:100,y:100,joins:[],aggregates:[]};this.model.tables.push(t),this.render(),this.$emit("change")},render(){this.rendered=!1,this.$nextTick(()=>{this.rendered=!0,this.$nextTick(()=>{const t=this.$refs.stage.getNode().container();t.addEventListener("dragover",function(l){l.preventDefault()}),t.addEventListener("drop",l=>{l.preventDefault(),this.handleDrop(l)}),this.computeRelations()})})},__deleteLine(){const e=this.relationLines.find(t=>t.id===this.model.selectedLineId);if(e.type==="join"){const t=this.model.joins.findIndex(a=>a.table.id===e.table.id&&a.targetTable.id===e.targetTable.id),l=this.model.joins[t],o=l.ons.findIndex(a=>a.field.name===e.field.name&&a.targetField.name===e.targetField.name);o!==-1&&l.ons.splice(o,1),l.ons.length===0&&this.model.joins.splice(t,1)}else{const t=this.model.aggregates.findIndex(l=>l.table.id===e.table.id&&l.targetTable.id===e.targetTable.id&&l.field.name===e.field.name&&l.targetField.name===e.targetField.name);this.model.aggregates.splice(t,1)}this.model.selectedLineId=null,this.$emit("change"),this.render()},__deleteTable(){const e=this.model.tables.findIndex(o=>o.id===this.model.selectedTableId),t=this.model.tables[e];let l=Promise.resolve();t.type==="MAIN"&&this.model.tables.length>1&&(l=this.$model.deleteConfirm("Deleting the main table will delete all the schedules and associations. Are you sure to delete it?")),l.then(()=>{if(t.type==="MAIN"){this.model.tables=[],this.model.joins=[],this.model.aggregates=[],this.$emit("change"),this.render();return}this.model.joins=this.model.joins.filter(o=>!(o.table.id===this.model.selectedTableId||o.targetTable.id===this.model.selectedTableId)),this.model.aggregates=this.model.aggregates.filter(o=>{if(o.table.id===this.model.selectedTableId||o.targetTable.id===this.model.selectedTableId)return!1}),this.model.tables.splice(e,1),this.$emit("change"),this.render()}).catch(()=>{})},__addJoinRelation(){if(this.relationRuntime.table.id===this.relationRuntime.targetTable.id){this.$tip.warning("The join relationship cannot be created.");return}let e=this.model.joins.find(t=>t.table.id===this.relationRuntime.table.id&&t.targetTable.id===this.relationRuntime.targetTable.id);e==null&&(e={table:this.relationRuntime.table,targetTable:this.relationRuntime.targetTable,joinType:"INNER JOIN",relation:"ONE-TO-ONE",ons:[]},this.model.joins.push(e)),e.ons.push({field:this.relationRuntime.field,targetField:this.relationRuntime.targetField,relation:"AND"}),this.computeRelations()},__addAggregate(){if(this.relationRuntime.table.id===this.relationRuntime.targetTable.id){this.$tip.warning("The aggregate relationship cannot be created.");return}let e=this.model.aggregates.find(t=>t.table.id===this.relationRuntime.table.id&&t.targetTable.id===this.relationRuntime.targetTable.id&&(t.field.name===this.relationRuntime.field.name||t.targetField.name===this.relationRuntime.targetField.name));e==null&&(e={table:this.relationRuntime.table,targetTable:this.relationRuntime.targetTable,field:this.relationRuntime.field,targetField:this.relationRuntime.targetField,function:"COUNT"},this.model.aggregates.push(e)),this.computeRelations()},__getFieldPosition(e,t,l=!0){const a=this.$refs.stage.getNode().getAbsolutePosition();let n=e.fields.findIndex(h=>h.visible&&h.name===t.name);if(n===-1)return null;let r=n;for(let h=0;h<r;h++)e.fields[h].visible||n--;if(n===-1)return null;const c=e.x+(l?200:0)-a.x,p=e.y+this.fieldHeight+(n+1)*this.fieldHeight-15-a.y;return{x:c,y:p}}},mounted(){this.render()}},Ye={class:"wrap"};function Ze(e,t,l,o,a,n){const r=f("Table"),c=f("RelationLine"),p=f("v-layer"),h=f("v-stage");return u(),b(V,null,[l.model.tables.length===0?(u(),b("div",{key:0,class:"empty-tip",onDragover:t[1]||(t[1]=U(()=>{},["prevent"])),onDrop:t[2]||(t[2]=(..._)=>n.handleDrop&&n.handleDrop(..._))},[s("div",Ye,[s("p",null,y(e.$t("database.dragTip")),1),s("p",null,y(e.$t("common.or")),1),s("p",null,[s("em",{onClick:t[0]||(t[0]=(..._)=>n.confirmCreateVirtualTable&&n.confirmCreateVirtualTable(..._))},y(e.$t("database.createVirtualTableTip")),1)])])],32)):w("",!0),s("div",{class:"stage-wrap",tabindex:"-1",onKeyup:t[5]||(t[5]=z((..._)=>n.handleDelete&&n.handleDelete(..._),["delete"]))},[a.rendered?(u(),M(h,{key:0,ref:"stage",config:a.configKonva,onMouseup:t[4]||(t[4]=_=>e.$refs.stage.getNode().draggable(!0)),onClick:n.globalClick},{default:g(()=>[(u(!0),b(V,null,k(l.model.tables,_=>(u(),M(r,{ref_for:!0,ref:_.id,key:_.name,"field-height":l.fieldHeight,x:_.x,y:_.y,table:_,relations:l.model.joins,selected:l.model.selectedTableId===_.id,onDragmove:n.moveTable,"onField:mousedown":n.handleFieldMouseDown,"onField:mouseup":n.handleFieldMouseUp,"onTable:select":n.handleTableSelect,"onTable:preview":n.handleTablePreview},null,8,["field-height","x","y","table","relations","selected","onDragmove","onField:mousedown","onField:mouseup","onTable:select","onTable:preview"]))),128)),d(p,null,{default:g(()=>[(u(!0),b(V,null,k(a.relationLines,_=>(u(),M(c,{key:_.id,"line-type":_.type,start:_.start,end:_.end,selected:l.model.selectedLineId===_.id,onSelect:i=>n.handleLineSelect(_),onUnselect:t[3]||(t[3]=i=>l.model.selectedLineId=null)},null,8,["line-type","start","end","selected","onSelect"]))),128))]),_:1})]),_:1},8,["config","onClick"])):w("",!0)],32)],64)}const et=F(Xe,[["render",Ze],["__scopeId","data-v-54c45d1b"]]);const tt={name:"TableLibrary",components:{InnerRouterView:ee,InnerRouterViewWindow:te},props:{queryModels:{required:!0},tables:{},currentModel:{}},data(){return{newModel:{name:"",comment:""},editModel:{id:null,name:"",comment:""},rules:{name:[{required:!0,message:"Please input model name"},{validator:(e,t,l)=>q(e,t,l,"Model name is incorrectly formatted")}]}}},computed:{...A(["currentDatabase"])},methods:{checkTableName:q,handleDragStart(e){this.$emit("table:drag",e.target.getAttribute("name"))},createQueryModel(){this.$refs.routerViewWindow.push("create-model");for(const e in this.newModel)this.newModel[e]="";this.$nextTick(()=>{this.$refs.createForm.clearValidate()})},updateModel(e){for(const t in this.editModel)this.editModel[t]=e[t];this.$refs.routerViewWindow.push("update-model"),this.$nextTick(()=>{this.$refs.createForm.clearValidate()})},confirmUpdate(){this.$refs.editForm.validate(e=>{e&&H({database:this.currentDatabase,model:this.editModel}).then(()=>{Object.assign(this.currentModel,this.editModel),this.$refs.routerViewWindow.back()}).catch(t=>{this.$tip.apiFailed(t)})})},confirmCreate(){this.$refs.createForm.validate(e=>{if(!e)return;const t={...this.newModel,lineType:"join",tables:[],joins:[],aggregates:[]};G({database:this.currentDatabase,model:t}).then(l=>{t.id=l,this.queryModels.unshift(t),this.selectModel(t),this.$refs.routerViewWindow.back()}).catch(l=>{this.$tip.apiFailed(l)})})},deleteModel(e){this.$model.deleteConfirm(`Do you want to delete the query model named 「${e.name}」`).then(()=>{X({database:this.currentDatabase,model:e.id}).then(()=>{const t=this.queryModels.findIndex(l=>l.id===e.id);t!==-1&&this.queryModels.splice(t,1),this.$tip.success("Delete successfully")}).catch(t=>{this.$tip.apiFailed(t)})}).catch(()=>{})},selectModel(e){this.$emit("update:currentModel",e)}}},lt={class:"table-library"},nt={class:"block"},at={class:"header",slot:"title"},it={class:"model-list"},st=["onClick"],ot=["onClick"],dt=["onClick"],rt={class:"create-model-form"},ut={class:"opera"},ht={class:"create-model-form"},ct={class:"opera"},mt={class:"block"},gt={class:"header"},bt={class:"table-list"},ft=["name"];function _t(e,t,l,o,a,n){const r=f("el-button"),c=f("Edit"),p=f("el-icon"),h=f("Delete"),_=f("InnerRouterView"),i=f("el-input"),v=f("el-form-item"),m=f("el-form"),x=f("InnerRouterViewWindow");return u(),b("div",lt,[s("div",nt,[d(x,{ref:"routerViewWindow",default:"query-models"},{default:g(()=>[d(_,{name:"query-models"},{default:g(()=>[s("div",at,[s("h4",null,y(e.$t("database.queryModels")),1),d(r,{type:"primary",icon:"Plus",class:"button-icon",onClick:n.createQueryModel},null,8,["onClick"])]),s("ul",it,[(u(!0),b(V,null,k(l.queryModels,T=>(u(),b("li",{key:T.name,class:L({selected:l.currentModel!=null&&l.currentModel.id===T.id}),onClick:S=>n.selectModel(T)},[s("p",null,y(T.name),1),s("div",null,[s("span",{onClick:U(S=>n.updateModel(T),["stop"])},[d(p,null,{default:g(()=>[d(c)]),_:1})],8,ot),s("span",{onClick:U(S=>n.deleteModel(T),["stop"])},[d(p,null,{default:g(()=>[d(h)]),_:1})],8,dt)])],10,st))),128))])]),_:1}),d(_,{name:"create-model",title:e.$t("database.createNewModel")},{default:g(()=>[s("div",rt,[d(m,{ref:"createForm",model:a.newModel,rules:a.rules},{default:g(()=>[d(v,{label:e.$t("common.name"),prop:"name",required:""},{default:g(()=>[d(i,{modelValue:a.newModel.name,"onUpdate:modelValue":t[0]||(t[0]=T=>a.newModel.name=T)},null,8,["modelValue"])]),_:1},8,["label"]),d(v,{label:e.$t("common.remark"),prop:"comment"},{default:g(()=>[d(i,{modelValue:a.newModel.comment,"onUpdate:modelValue":t[1]||(t[1]=T=>a.newModel.comment=T),type:"textarea",rows:2},null,8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model","rules"]),s("div",ut,[d(r,{onClick:t[2]||(t[2]=T=>e.$refs.routerViewWindow.back())},{default:g(()=>[I(y(e.$t("common.cancel")),1)]),_:1}),d(r,{type:"primary",onClick:n.confirmCreate},{default:g(()=>[I(y(e.$t("common.confirm")),1)]),_:1},8,["onClick"])])])]),_:1},8,["title"]),d(_,{name:"update-model",title:"Update Model"},{default:g(()=>[s("div",ht,[d(m,{ref:"editForm",model:a.editModel,rules:a.rules},{default:g(()=>[d(v,{label:"Model Name",prop:"name",required:""},{default:g(()=>[d(i,{modelValue:a.editModel.name,"onUpdate:modelValue":t[3]||(t[3]=T=>a.editModel.name=T)},null,8,["modelValue"])]),_:1}),d(v,{label:"Comment",prop:"comment"},{default:g(()=>[d(i,{modelValue:a.editModel.comment,"onUpdate:modelValue":t[4]||(t[4]=T=>a.editModel.comment=T),type:"textarea",rows:2},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),s("div",ct,[d(r,{onClick:t[5]||(t[5]=T=>e.$refs.routerViewWindow.back())},{default:g(()=>[I("Cancel")]),_:1}),d(r,{type:"primary",onClick:n.confirmUpdate},{default:g(()=>[I("Confirm")]),_:1},8,["onClick"])])])]),_:1})]),_:1},512)]),s("div",mt,[s("div",gt,[s("h4",null,y(e.$t("database.tables")),1)]),s("ul",bt,[(u(!0),b(V,null,k(l.tables,T=>(u(),b("li",{key:T.name,name:T.name,draggable:"true",onDragstart:t[6]||(t[6]=(...S)=>n.handleDragStart&&n.handleDragStart(...S))},y(T.name)+"("+y(T.comment)+")",41,ft))),128))])])])}const pt=F(tt,[["render",_t],["__scopeId","data-v-d375d58f"]]);const yt={components:{TableLibrary:pt,QueryModelDesigner:et,TableSetting:Ge,RelationLine:E,Table:W},data(){return{fieldHeight:30,queryModels:[],databases:[],tables:[],lineType:"join",currentModel:null}},computed:{...A(["currentProject","currentDatabase"]),currentTable(){return this.currentModel==null||this.currentModel.previewTableId==null?null:this.currentModel.tables.find(e=>e.id===this.currentModel.previewTableId)},currentTableJoins(){return this.currentTable==null||this.currentTable.type!=="MAIN"?[]:this.currentModel.joins},currentTableAggregates(){return this.currentTable==null||this.currentTable.type!=="MAIN"?[]:this.currentModel.aggregates.filter(e=>e.table.id===this.currentTable.id)}},methods:{saveModel(){const e=this.__getModelSettings(this.currentModel);H({database:this.currentDatabase,model:e}).then(()=>{console.log("保存成功")}).catch(t=>{this.$tip.apiFailed(t)})},handleSettingChange(){this.saveModel(),this.$refs.designer.render()},handleDragStart(e){this.currentModel.dragData=this.tables.find(t=>t.name===e)},fetchDatabases(){Y().then(e=>{this.databases=e,this.fetchTables()}).catch(e=>{this.$tip.apiFailed(e)})},fetchTables(){const e=this.databases.find(t=>t.id===this.currentDatabase);Z({host:e.host,port:e.port,user:e.username,password:e.password,database:e.schema}).then(t=>{this.tables=t.map(l=>({...l,alias:l.name,fields:l.fields.map(o=>({...o,isVirtual:!1}))})),this.fetchModels()}).catch(t=>{this.$tip.apiFailed(t)})},fetchModels(){const t=this.databases.find(l=>l.id===this.currentDatabase).models;this.queryModels=t.map(l=>(l.tables=l.tables.map(o=>{const a=this.tables.find(r=>r.name.toLowerCase()===o.name.toLowerCase());if(a==null&&!o.isVirtual)return null;let n=o.fields;return a!=null&&(n=a.fields.map(r=>{const c=o.fields.find(p=>p.name===r.name);return this.__modelField2field(c,r)})),{...o,fields:n,joins:[]}}),l.tables=l.tables.filter(o=>o!=null),l.joins.map(o=>this.__modelJoin2join(l,o)),l.joins=l.joins.filter(o=>o!=null),l.aggregates.map(o=>this.__modelAggregate2Aggregate(l,o)),l.aggregates=l.aggregates.filter(o=>o!=null),l))},__getModelSettings(e){const t=e.tables.map(a=>({id:a.id,name:a.name,alias:a.alias,isVirtual:a.isVirtual,type:a.type,fields:a.fields.map(n=>{const r={};for(const c in n)c==="table"||c.startsWith("__")||(r[c]=n[c]);return r}),x:a.x,y:a.y})),l=e.joins.map(a=>({...a,table:a.table.id,targetTable:a.targetTable.id,ons:a.ons.map(n=>({field:n.field.name,targetField:n.targetField.name,relation:n.relation}))})),o=e.aggregates.map(a=>({table:a.table.id,targetTable:a.targetTable.id,field:a.field.name,targetField:a.targetField.name,function:a.function}));return{id:e.id,name:e.name,comment:e.comment,tables:t,joins:l,aggregates:o}},__modelField2field(e,t){return t!=null&&e==null?{...t,visible:!1,alias:t.name,isVirtual:!1}:t==null?null:{...t,alias:e.alias,isVirtual:e.isVirtual,type:e.isVirtual?e.type:t.type,comment:e.isVirtual?e.comment:t.comment,visible:!0}},__modelJoin2join(e,t){const l=e.tables.find(n=>n.id===t.table),o=e.tables.find(n=>n.id===t.targetTable);if(l==null||o==null)return null;t.table=l,t.targetTable=o;const a=[];for(const n of t.ons){const r=l.fields.find(p=>p.name.toLowerCase()===n.field.toLowerCase()),c=o.fields.find(p=>p.name.toLowerCase()===n.targetField.toLowerCase());r==null||c==null||a.push({field:r,targetField:c,relation:n.relation})}return a.length===0?null:(t.ons=a,t)},__modelAggregate2Aggregate(e,t){const l=e.tables.find(r=>r.id===t.table),o=e.tables.find(r=>r.id===t.targetTable);if(l==null||o==null)return null;t.table=l,t.targetTable=o;const a=l.fields.find(r=>r.name.toLowerCase()===t.field.toLowerCase()),n=o.fields.find(r=>r.name.toLowerCase()===t.targetField.toLowerCase());return a==null||n==null?null:(t.field=a,t.targetField=n,t)}},created(){this.fetchDatabases()}},Q=e=>(P("data-v-20c96901"),e=e(),O(),e),vt={class:"database-query-models"},Tt={class:"designer-wrap"},Ct={key:0,class:"toolbar"},Vt={class:"line-types"},Mt=Q(()=>s("em",{class:"join-line"},null,-1)),wt=Q(()=>s("em",{class:"aggregate-line"},null,-1));function kt(e,t,l,o,a,n){const r=f("TableLibrary"),c=f("QueryModelDesigner"),p=f("TableSetting");return u(),b("div",vt,[d(r,{"query-models":a.queryModels,tables:a.tables,"onTable:drag":n.handleDragStart,"current-model":a.currentModel,"onUpdate:currentModel":t[0]||(t[0]=h=>a.currentModel=h)},null,8,["query-models","tables","onTable:drag","current-model"]),s("div",Tt,[a.currentModel!=null?(u(),b("div",Ct,[s("ul",Vt,[s("li",{class:L({selected:a.currentModel.lineType==="join"}),onClick:t[1]||(t[1]=h=>a.currentModel.lineType="join")},[Mt,s("label",null,y(e.$t("database.joinLine")),1)],2),s("li",{class:L({selected:a.currentModel.lineType==="aggregate"}),onClick:t[2]||(t[2]=h=>a.currentModel.lineType="aggregate")},[wt,s("label",null,y(e.$t("database.aggregateLine")),1)],2)])])):w("",!0),a.currentModel!=null?(u(),M(c,{key:1,ref:"designer",model:a.currentModel,"field-height":30,onChange:n.saveModel},null,8,["model","onChange"])):w("",!0),d(p,{table:n.currentTable,"table-joins":n.currentTableJoins,aggregates:n.currentTableAggregates,"onField:change":n.handleSettingChange},null,8,["table","table-joins","aggregates","onField:change"])])])}const St=F(yt,[["render",kt],["__scopeId","data-v-20c96901"]]);export{St as default};
