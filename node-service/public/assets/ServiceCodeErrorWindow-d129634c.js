import{_ as I,o as n,c,F as k,g as C,J as T,t as g,r as s,h,w as p,a as _,j as F,b as v,a3 as U,A as $,B as q,m as K,i as z,aa as O,k as P,e as x,p as Q,l as D,ab as N}from"./index-3e8fc5cf.js";import{Q as X}from"./QueryModelView-02a3ba77.js";const Y={name:"InstallCheckbox",props:{modelValue:{type:Array},type:{default:"checkbox"},options:{}},data(){return{}},computed:{optionValues(){return this.options.map(l=>l.value)}},watch:{modelValue:{immediate:!0,handler(){this.filterValues(this.modelValue)}},optionValues(){this.filterValues(this.modelValue)}},methods:{handleSelect(l){let t=this.modelValue.findIndex(a=>a===l.value),e=[];t===-1?e=this.modelValue.concat([l.value]):e=this.modelValue.filter((a,d)=>d!==t),this.filterValues(e)},filterValues(l){const t=[];for(const e of l)this.options.find(d=>d.value===e)!=null&&t.push(e);t!==this.modelValue&&(t!=null&&this.modelValue!=null&&t.join(",")===this.modelValue.join(",")||(this.$emit("update:modelValue",t),this.$emit("change",t)))}}},Z={key:0,class:"installer-checkbox"},ee=["onClick"],le={key:1};function te(l,t,e,a,d,o){return e.options.length>0?(n(),c("ul",Z,[(n(!0),c(k,null,C(e.options,r=>(n(),c("li",{key:r.value,class:T({selected:e.modelValue==null?!1:e.modelValue.findIndex(f=>f===r.value)!==-1}),onClick:f=>o.handleSelect(r)},g(r.label),11,ee))),128))])):(n(),c("p",le,"请先添加选项！"))}const E=I(Y,[["render",te],["__scopeId","data-v-88cce27a"]]);const ne={name:"InstallInput",props:{type:{default:"text"},rows:{default:3}}};function ae(l,t,e,a,d,o){const r=s("el-input");return n(),h(r,{type:e.type,rows:e.rows,class:"install-input"},null,8,["type","rows"])}const L=I(ne,[["render",ae],["__scopeId","data-v-35abcc78"]]);const oe={name:"InstallRadio",props:{modelValue:{},options:{}},data(){return{optionSettingData:{visible:!1}}},methods:{handleSelect(l){this.$emit("update:modelValue",l),this.$emit("change",l)}}},ie={key:0,class:"installer-radio"},se=["onClick"],ue={key:1};function de(l,t,e,a,d,o){return e.options.length>0?(n(),c("ul",ie,[(n(!0),c(k,null,C(e.options,r=>(n(),c("li",{key:r.value,class:T({selected:e.modelValue===r.value}),onClick:f=>o.handleSelect(r.value)},g(r.label),11,se))),128))])):(n(),c("p",ue,"请先添加选项！"))}const W=I(oe,[["render",de],["__scopeId","data-v-0d9060ef"]]);const re={name:"MySqlFieldSelect",props:{modelValue:{},table:{required:!0},multiple:{default:!0}},methods:{handleInput(l){this.$emit("update:modelValue",l.map(t=>this.table.fields.find(e=>e.name===t)).filter(t=>t!=null))}}},ce={class:"option-content"},me={class:"text-info-1"};function _e(l,t,e,a,d,o){const r=s("el-option"),f=s("el-select");return n(),h(f,{class:"mysql-field-select","popper-class":"mysql-field-select__popper",multiple:e.multiple,"model-value":e.modelValue==null?[]:e.modelValue.map(b=>b.name),"onUpdate:modelValue":o.handleInput},{default:p(()=>[(n(!0),c(k,null,C(e.table.fields,b=>(n(),h(r,{value:b.name,label:b.name},{default:p(()=>[_("p",ce,[_("span",null,g(b.name),1),_("span",me,g(b.comment),1)])]),_:2},1032,["value","label"]))),256))]),_:1},8,["multiple","model-value","onUpdate:modelValue"])}const he=I(re,[["render",_e],["__scopeId","data-v-3550a1ac"]]);const pe={name:"OptionValueInput",props:{modelValue:{},optionSetting:{required:!0}},methods:{emitChange(l){this.$emit("update:model-value",l),this.$emit("input",l)}}},ve={class:"option-value-input"};function be(l,t,e,a,d,o){const r=s("el-input"),f=s("el-input-number");return n(),c("div",ve,[e.optionSetting.inputType==="input"?(n(),h(r,{key:0,"model-value":e.modelValue,"onUpdate:modelValue":o.emitChange},null,8,["model-value","onUpdate:modelValue"])):e.optionSetting.inputType==="number_input"?(n(),h(f,{key:1,"model-value":e.modelValue,controls:!1,"onUpdate:modelValue":o.emitChange},null,8,["model-value","onUpdate:modelValue"])):e.optionSetting.inputType==="textarea"?(n(),h(r,{key:2,type:"textarea",rows:1,"model-value":e.modelValue,"onUpdate:modelValue":o.emitChange},null,8,["model-value","onUpdate:modelValue"])):F("",!0)])}const fe=I(pe,[["render",be],["__scopeId","data-v-c1e053d5"]]);const ge={name:"InstallSelect",components:{OptionValueInput:fe},props:{modelValue:{},options:{},type:{default:"radio"}},data(){return{optionSettingData:{visible:!1}}},computed:{validOptions(){return this.options.filter(l=>l.value.trim()!==""&&l.label.trim()!=="")},currentOption(){return this.validOptions.find(l=>l.value===this.modelValue.value)},optionValues(){return this.validOptions.map(l=>l.value)},currenOptionSettings(){return this.currentOption==null?[]:this.currentOption.settings.map(l=>l.defaultValue)}},watch:{optionValues(){this.handleSelect(this.modelValue.value)},currenOptionSettings(){this.fillSettingValue()},modelValue:{immediate:!0,handler(){this.fillSettingValueFromModelValue()}}},methods:{handleSelect(l){const t=this.validOptions.find(a=>a.value===l);let e={value:null,settings:{}};if(t!=null){const a={};for(const d of t.settings)a[d.name]=d.defaultValue;e={value:l,settings:a}}this.$emit("update:modelValue",e),this.$emit("change",e),this.fillSettingValue()},fillSettingValue(){this.$nextTick(()=>{if(this.currentOption!=null)for(const l of this.currentOption.settings)l.value=l.defaultValue})},fillSettingValueFromModelValue(){for(const l in this.modelValue.settings){const t=this.options.find(a=>a.value===this.modelValue.value);if(t==null)continue;const e=t.settings.find(a=>a.name===l);e!=null&&(e.value=this.modelValue.settings[l])}}}},ye={key:0,class:"installer-select"},Ve={key:1};function Se(l,t,e,a,d,o){const r=s("el-option"),f=s("el-select"),b=s("el-button"),S=s("OptionValueInput"),y=s("el-form-item"),V=s("el-form"),u=s("el-dialog");return e.options.length>0?(n(),c("div",ye,[v(f,{"model-value":e.modelValue.value,clearable:"",onChange:o.handleSelect},{default:p(()=>[(n(!0),c(k,null,C(o.validOptions,i=>(n(),h(r,{key:i.value,value:i.value,label:i.label},null,8,["value","label"]))),128))]),_:1},8,["model-value","onChange"]),o.currentOption!=null&&o.currentOption.settings.length>0?(n(),h(b,{key:0,type:"primary",icon:"Setting",class:"button-icon",onClick:t[0]||(t[0]=i=>d.optionSettingData.visible=!0)})):F("",!0),o.currentOption!=null?(n(),h(u,{key:1,modelValue:d.optionSettingData.visible,"onUpdate:modelValue":t[2]||(t[2]=i=>d.optionSettingData.visible=i),title:`${o.currentOption.label}设置`,"append-to-body":!0},{default:p(()=>[v(V,null,{default:p(()=>[(n(!0),c(k,null,C(o.currentOption.settings,i=>(n(),h(y,{key:i.name,label:i.label,required:i.required},{default:p(()=>[v(S,{modelValue:e.modelValue.settings[i.name],"onUpdate:modelValue":w=>e.modelValue.settings[i.name]=w,"option-setting":i,onInput:t[1]||(t[1]=w=>l.$emit("change"))},null,8,["modelValue","onUpdate:modelValue","option-setting"])]),_:2},1032,["label","required"]))),128))]),_:1})]),_:1},8,["modelValue","title"])):F("",!0)])):(n(),c("p",Ve,"请先添加选项！"))}const j=I(ge,[["render",Se],["__scopeId","data-v-a5cf2462"]]);const ke={name:"InstallNumberInput",props:{type:{default:"text"}}};function Ie(l,t,e,a,d,o){const r=s("el-input-number");return n(),h(r,{class:"install-number-input",controls:!1})}const R=I(ke,[["render",Ie],["__scopeId","data-v-6340b22c"]]),Fe={name:"Switch"};function Ce(l,t,e,a,d,o){const r=s("el-switch");return n(),h(r)}const A=I(Fe,[["render",Ce]]);const we={name:"TableFieldVariableInput",components:{InstallSwitch:A,InstallNumberInput:R,InstallSelect:j,InstallCheckbox:E,InstallRadio:W,InstallInput:L},props:{modelValue:{},variable:{required:!0}}};function Te(l,t,e,a,d,o){const r=s("InstallInput"),f=s("InstallNumberInput"),b=s("InstallSelect"),S=s("InstallCheckbox"),y=s("InstallRadio"),V=s("InstallSwitch");return e.variable.inputType==="input"?(n(),h(r,{key:0,"model-value":e.modelValue,"onUpdate:modelValue":t[0]||(t[0]=u=>l.$emit("update:modelValue",u)),onInput:t[1]||(t[1]=u=>l.$emit("change",u))},null,8,["model-value"])):e.variable.inputType==="number_input"?(n(),h(f,{key:1,"model-value":e.modelValue,"onUpdate:modelValue":t[2]||(t[2]=u=>l.$emit("update:modelValue",u)),onInput:t[3]||(t[3]=u=>l.$emit("change",u))},null,8,["model-value"])):e.variable.inputType==="textarea"?(n(),h(r,{key:2,type:"textarea",rows:1,"model-value":e.modelValue,"onUpdate:modelValue":t[4]||(t[4]=u=>l.$emit("update:modelValue",u)),onInput:t[5]||(t[5]=u=>l.$emit("change",u))},null,8,["model-value"])):e.variable.inputType==="select"?(n(),h(b,{key:3,options:e.variable.options,"model-value":e.modelValue,"onUpdate:modelValue":t[6]||(t[6]=u=>l.$emit("update:modelValue",u)),onChange:t[7]||(t[7]=u=>l.$emit("change",u))},null,8,["options","model-value"])):e.variable.inputType==="checkbox"?(n(),h(S,{key:4,options:e.variable.options,"model-value":e.modelValue,"onUpdate:modelValue":t[8]||(t[8]=u=>l.$emit("update:modelValue",u)),onChange:t[9]||(t[9]=u=>l.$emit("change",u))},null,8,["options","model-value"])):e.variable.inputType==="radio"?(n(),h(y,{key:5,options:e.variable.options,"model-value":e.modelValue,"onUpdate:modelValue":t[10]||(t[10]=u=>l.$emit("update:modelValue",u)),onChange:t[11]||(t[11]=u=>l.$emit("change",u))},null,8,["options","model-value"])):e.variable.inputType==="switch"?(n(),h(V,{key:6,"model-value":e.modelValue,"onUpdate:modelValue":t[12]||(t[12]=u=>l.$emit("update:modelValue",u)),onChange:t[13]||(t[13]=u=>l.$emit("change",u))},null,8,["model-value"])):F("",!0)}const H=I(we,[["render",Te],["__scopeId","data-v-f253c4c5"]]);const xe={name:"VariableRemarkIcon",props:{variable:{required:!0}}};function Me(l,t,e,a,d,o){const r=s("QuestionFilled"),f=s("el-icon"),b=s("el-popover");return e.variable.remark!=null&&e.variable.remark.trim()!==""?(n(),h(b,{key:0,"popper-class":"global-popover",title:"参数说明",placement:"top",width:"255px"},{reference:p(()=>[v(f,null,{default:p(()=>[v(r)]),_:1})]),default:p(()=>[_("p",null,g(e.variable.remark),1)]),_:1})):F("",!0)}const J=I(xe,[["render",Me],["__scopeId","data-v-9fef24ee"]]);function M(l){return l==null||l===""||JSON.stringify(l)==="[]"||JSON.stringify(l)==="{}"}function B(l){return l==="input"||l==="textarea"||l==="radio"?"":l==="select"?{value:null,settings:[]}:l==="checkbox"?[]:l==="table"||l==="database"||l==="query_model"?null:""}const Ke={name:"FieldSetting",components:{SortableButton:U,VariableRemarkIcon:J,TableFieldVariableInput:H,MySqlFieldSelect:he},props:{table:{required:!0},group:{required:!0},valueKey:{default:"value"}},computed:{tableFields(){return this.table.fields.map(l=>l.name)}},watch:{tableFields(){this.handleSelect(this.group[this.valueKey])}},methods:{handleSort(l){console.log("newFields",l),this.handleSelect(l)},handleSelect(l){l=l.filter(e=>this.table.fields.find(a=>a.name===e.name)!=null);const t=JSON.parse(JSON.stringify(l));for(const e of t){e.origin==null&&(e.origin=JSON.parse(JSON.stringify(e)));for(const a of this.group.children)e[a.name]=M(e[a.name])?a.defaultValue:e[a.name],M(e[a.name])&&(e[a.name]=B(a.inputType))}this.group[this.valueKey]=t,console.log("this.group[this.valueKey]",this.group[this.valueKey]),this.emitChange()},emitChange(){this.$emit("change")},getColumnMinWidth(l){return l.inputType==="select"?"150px":"120px"}},created(){this.handleSelect(this.group[this.valueKey])}},Oe={class:"column-header-wrap"},Ue={key:0,class:"required"};function $e(l,t,e,a,d,o){const r=s("MySqlFieldSelect"),f=s("SortableButton"),b=s("el-table-column"),S=s("VariableRemarkIcon"),y=s("TableFieldVariableInput"),V=s("el-table"),u=$("sortable");return n(),c(k,null,[_("h5",null,g(e.group.label),1),v(r,{"onUpdate:modelValue":o.handleSelect,"model-value":e.group[e.valueKey],table:e.table,placeholder:"请选择字段"},null,8,["onUpdate:modelValue","model-value","table"]),q((n(),h(V,{size:"small",data:e.group[e.valueKey],"row-key":"name"},{default:p(()=>[v(b,{"class-name":"table-column-sortable",width:"30px",fixed:""},{default:p(()=>[v(f)]),_:1}),v(b,{label:"字段名",width:"100px",prop:"name",fixed:""}),(n(!0),c(k,null,C(e.group.children,i=>(n(),h(b,{key:i.name,label:i.label,"min-width":o.getColumnMinWidth(i)},{header:p(()=>[_("div",Oe,[i.required?(n(),c("em",Ue,"*")):F("",!0),_("label",null,g(i.label),1),v(S,{variable:i},null,8,["variable"])])]),default:p(({row:w})=>[v(y,{variable:i,modelValue:w[i.name],"onUpdate:modelValue":m=>w[i.name]=m,onChange:o.emitChange},null,8,["variable","modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["label","min-width"]))),128))]),_:1},8,["data"])),[[u,{handle:".sortable-button",data:e.group[e.valueKey],onChange:o.handleSort},"config"]])],64)}const qe=I(Ke,[["render",$e],["__scopeId","data-v-ed8d68cf"]]);const Qe={name:"TableSelect",components:{FieldSetting:qe},props:{modelValue:{},valueKey:{default:"value"},variable:{required:!0}},data(){return{selected:null}},computed:{...K(["tables","globalLoading","currentDatabaseConnect"]),fieldVariableGroup(){return this.variable.children||[]},currentTable(){return this.modelValue==null?null:this.tables.find(l=>l.name===this.modelValue)}},watch:{"globalLoading.tables":{immediate:!0,handler(l){l||this.handleChange(this.modelValue)}}},methods:{...z(["fetchTables"]),handleChange(l){if(!this.globalLoading.tables){if(this.modelValue!==l&&this.fieldVariableGroup.forEach(t=>{t[this.valueKey]=[]}),this.tables.find(t=>t.name===l)==null){this.$emit("update:modelValue",null),this.$emit("change",null);return}this.$emit("update:modelValue",l),this.$emit("change",l)}}}},De={class:"table-select"},Ne={class:"table-select__wrap"},Ee={class:"option-content"},Le={class:"text-info-1"},We={key:0,class:"connect-error"},je={key:1,class:"field-settings"};function Re(l,t,e,a,d,o){const r=s("el-option"),f=s("el-select"),b=s("el-button"),S=s("FieldSetting");return n(),c("div",De,[_("div",Ne,[v(f,{"popper-class":"table-select__popper","model-value":e.modelValue,clearable:"",loading:l.globalLoading.tables,"loading-text":"正在获取数据库表，请稍后...",onChange:o.handleChange},{default:p(()=>[(n(!0),c(k,null,C(l.tables,y=>(n(),h(r,{key:y.name,value:y.name,label:y.name},{default:p(()=>[_("p",Ee,[_("span",null,g(y.name),1),_("span",Le,g(y.comment),1)])]),_:2},1032,["value","label"]))),128))]),_:1},8,["model-value","loading","onChange"]),v(b,{class:"button-icon",type:"primary",icon:"Refresh",onClick:l.fetchTables},null,8,["onClick"])]),l.currentDatabaseConnect.error!=null?(n(),c("p",We,"数据库连接失败："+g(l.currentDatabaseConnect.error),1)):F("",!0),o.currentTable!=null&&o.fieldVariableGroup.length>0?(n(),c("ul",je,[(n(!0),c(k,null,C(o.fieldVariableGroup,y=>(n(),c("li",{key:y.label},[v(S,{"value-key":e.valueKey,table:o.currentTable,group:y,onChange:t[0]||(t[0]=V=>l.$emit("change"))},null,8,["value-key","table","group"])]))),128))])):F("",!0)])}const Ae=I(Qe,[["render",Re],["__scopeId","data-v-8ee56717"]]);const He={name:"QueryModelFieldSelect",props:{modelValue:{},model:{required:!0},multiple:{default:!0},defaultSelectedFieldObjects:{type:Array}},data(){return{focused:!1,tables:[],selectedFields:this.defaultSelectedFieldObjects,currentHoverTable:null,currentHoverField:null,leaveFieldTimeout:null}},watch:{model:{immediate:!0,handler(){this.refreshTables()}}},methods:{focus(){this.focused=!0},deleteField(l,t){const e=this.model.tables.find(d=>d.id===l),a=this.modelValue.filter(d=>`${e.id}.${t}`!==d);this.handleInput(e,a)},handleCheckAllChange(l,t){let e=[];t&&(e=l.fields.map(d=>`${l.id}.${d.name}`));let a=this.modelValue;a=a.filter(d=>!d.startsWith(`${l.id}.`)),a=a.concat(e),this.handleInput(l,a)},handleInput(l,t){const e=t.filter(a=>a.startsWith(`${l.id}.`));l.checkedAll=e.length===l.fields.length,this.selectFields(t)},handleFieldEnter(l){this.leaveFieldTimeout!=null&&clearTimeout(this.leaveFieldTimeout),this.currentHoverField=l},handleFieldLeave(){this.leaveFieldTimeout=setTimeout(()=>{this.currentHoverField=null},500)},handleTableEnter(l){this.currentHoverTable=l},handleTableLeave(){this.currentHoverTable=null},close(){this.focused=!1,this.handleTableLeave(),this.handleFieldLeave()},refreshTables(){this.tables=[];for(const l of this.model.tables){const t=l.fields.filter(e=>e.visible);t.length>0&&this.tables.push({id:l.id,type:l.type,name:l.name,alias:l.alias,fields:t,checkedAll:!1})}this.selectFields(this.modelValue)},selectFields(l){const t=this.__getExistsSelectedFieldsObjects(l);this.selectedFields.splice(0,this.selectedFields.length),this.selectedFields.push.apply(this.selectedFields,t),this.$emit("update:modelValue",this.selectedFields.map(e=>e.table.id+"."+e.name)),this.$emit("fields:change",this.selectedFields)},__getExistsSelectedFieldsObjects(l){const t=l.map(a=>{const d=a.split(".")[0],o=a.split(".")[1],r=this.tables.find(y=>y.id===d);if(r==null)return null;const f=r.fields.find(y=>y.name===o);if(f==null)return null;const b=O(r,["fields"]),S=O(f,["table"]);return S.table=b,S}).filter(a=>a!=null),e=[];for(const a of t){const d=this.selectedFields.findIndex(r=>r.table.id===a.table.id&&r.name===a.name);if(d===-1){e.push(a);continue}const o=this.selectedFields[d];o.alias=a.alias,o.table=a.table,e.push(o)}return e}}},Je=l=>(Q("data-v-1178df68"),l=l(),D(),l),Be={class:"model-field-select"},Ge={key:0,class:"placeholder"},ze=["onMouseenter"],Pe={key:0},Xe=["onClick"],Ye={class:"field-select__tables"},Ze=["onMouseenter"],el={class:"table__header"},ll={class:"table__fields-wrap"},tl={class:"table-fields"},nl=Je(()=>_("em",null,"AS",-1)),al={key:0,class:"text-info-1"};function ol(l,t,e,a,d,o){const r=s("Close"),f=s("el-icon"),b=s("el-checkbox"),S=s("el-checkbox-group"),y=s("el-scrollbar"),V=s("el-popover");return n(),c("div",Be,[v(V,{trigger:"click","popper-class":"model-field-select-popper","hide-after":0,persistent:!1,onHide:o.close},{reference:p(()=>[_("ul",{class:T(["selected-preview",{"is-focus":d.focused}]),onClick:t[1]||(t[1]=(...u)=>o.focus&&o.focus(...u))},[d.selectedFields.length===0?(n(),c("li",Ge,"请选择字段")):(n(!0),c(k,{key:1},C(d.selectedFields,u=>(n(),c("li",{key:u.name,class:T({"field-light":d.currentHoverTable!=null&&u.table.id===d.currentHoverTable.id}),onMouseenter:i=>o.handleFieldEnter(u),onMouseleave:t[0]||(t[0]=(...i)=>o.handleFieldLeave&&o.handleFieldLeave(...i))},[_("p",null,g(u.table.alias)+"."+g(u.name),1),u.comment!=null&&u.comment!==""?(n(),c("p",Pe,g(u.comment),1)):F("",!0),_("span",{class:"button-close",onClick:P(i=>o.deleteField(u.table.id,u.name),["stop"])},[v(f,null,{default:p(()=>[v(r)]),_:1})],8,Xe)],42,ze))),128))],2)]),default:p(()=>[_("div",Ye,[(n(!0),c(k,null,C(d.tables,u=>(n(),c("div",{key:u.alias,class:T(["field-select__table",{"table-main":u.type==="MAIN","table-light":d.currentHoverField!=null&&u.id===d.currentHoverField.table.id}]),onMouseenter:i=>o.handleTableEnter(u),onMouseleave:t[2]||(t[2]=(...i)=>o.handleTableLeave&&o.handleTableLeave(...i))},[_("div",el,[v(b,{modelValue:u.checkedAll,"onUpdate:modelValue":i=>u.checkedAll=i,onChange:i=>o.handleCheckAllChange(u,i)},{default:p(()=>[_("h4",null,[x(g(u.name)+" ",1),u.name!==u.alias?(n(),c(k,{key:0},[x("AS "+g(u.alias),1)],64)):F("",!0)])]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_("div",ll,[v(y,null,{default:p(()=>[_("div",tl,[v(S,{"model-value":e.modelValue,onChange:i=>o.handleInput(u,i)},{default:p(()=>[(n(!0),c(k,null,C(u.fields,i=>(n(),h(b,{label:`${u.id}.${i.name}`,key:i.name},{default:p(()=>[_("p",null,[x(g(i.name)+" ",1),i.alias!==i.name?(n(),c(k,{key:0},[nl,x(),_("b",null,g(i.alias),1)],64)):F("",!0)]),i.comment!==""?(n(),c("p",al,g(i.comment),1)):F("",!0)]),_:2},1032,["label"]))),128))]),_:2},1032,["model-value","onChange"])])]),_:2},1024)])],42,Ze))),128))])]),_:1},8,["onHide"])])}const il=I(He,[["render",ol],["__scopeId","data-v-1178df68"]]);const sl={name:"QueryModelFieldSetting",components:{VariableRemarkIcon:J,SortableButton:U,QueryModelFieldSelect:il,TableFieldVariableInput:H},props:{valueKey:{default:"value"},model:{required:!0},group:{required:!0}},data(){return{selectedFields:[],defaultSelectedFieldObjects:[]}},watch:{model(){this.initSelectedFields()}},methods:{handleSort(){this.initSelectedFields(),this.$refs.fieldSelect.selectFields(this.selectedFields)},initSelectedFields(){this.selectedFields=[],this.defaultSelectedFieldObjects=[];const l=this.group[this.valueKey];l!=null&&l.length>0&&(this.selectedFields=l.map(t=>`${t.table.id}.${t.name}`),this.defaultSelectedFieldObjects=JSON.parse(JSON.stringify(l)))},handleSelect(l){const t=[];for(const e of l){e.origin==null&&(e.origin=JSON.parse(JSON.stringify(e)));for(const a of this.group.children)e[a.name]=M(e[a.name])?a.defaultValue:e[a.name],M(e[a.name])&&(e[a.name]=B(a.inputType));t.push(e)}this.group[this.valueKey].splice(0,this.group[this.valueKey].length),this.group[this.valueKey].push.apply(this.group[this.valueKey],t),this.emitChange()},emitChange(){this.$emit("change")},getColumnMinWidth(l){return l.inputType==="select"?"150px":"120px"},refresh(){this.$refs.fieldSelect.refreshTables()}},created(){this.initSelectedFields()}},ul={key:0,class:"required"};function dl(l,t,e,a,d,o){const r=s("QueryModelFieldSelect"),f=s("SortableButton"),b=s("el-table-column"),S=s("VariableRemarkIcon"),y=s("TableFieldVariableInput"),V=s("el-table"),u=$("sortable");return n(),c(k,null,[_("h5",null,g(e.group.label),1),v(r,{ref:"fieldSelect",modelValue:d.selectedFields,"onUpdate:modelValue":t[0]||(t[0]=i=>d.selectedFields=i),model:e.model,"default-selected-field-objects":d.defaultSelectedFieldObjects,"onFields:change":o.handleSelect},null,8,["modelValue","model","default-selected-field-objects","onFields:change"]),e.group.children.length>0?q((n(),h(V,{key:0,size:"small",data:e.group[e.valueKey],"row-key":i=>`${i.table.id}.${i.name}@${i.alias}`},{default:p(()=>[v(b,{"class-name":"table-column-sortable",width:"30px",fixed:""},{default:p(()=>[v(f)]),_:1}),v(b,{label:"字段名",width:"150px",prop:"name",fixed:""},{default:p(({row:i})=>[_("p",null,g(i.table.alias)+"."+g(i.name),1),_("p",null,g(i.comment),1)]),_:1}),(n(!0),c(k,null,C(e.group.children,i=>(n(),h(b,{key:i.name,label:i.label,"min-width":o.getColumnMinWidth(i)},{header:p(()=>[i.required?(n(),c("em",ul,"*")):F("",!0),_("label",null,g(i.label),1),v(S,{variable:i},null,8,["variable"])]),default:p(({row:w})=>[v(y,{variable:i,modelValue:w[i.name],"onUpdate:modelValue":m=>w[i.name]=m,onChange:o.emitChange},null,8,["variable","modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["label","min-width"]))),128))]),_:1},8,["data","row-key"])),[[u,{handle:".sortable-button",data:e.group[e.valueKey],onChange:o.handleSort},"config"]]):F("",!0)],64)}const rl=I(sl,[["render",dl],["__scopeId","data-v-74db6d23"]]);const cl={name:"QueryModelWindow",components:{DataSourceSelect:N,QueryModelView:X},data(){return{visible:!1}},computed:{...K(["currentDatabase"])},methods:{open(){this.visible=!0},close(){this.visible=!1,this.$emit("close")}}},ml=_("h2",null,"查询模型设计",-1),_l={class:"header__opera"};function hl(l,t,e,a,d,o){const r=s("DataSourceSelect"),f=s("Close"),b=s("el-icon"),S=s("QueryModelView"),y=s("el-dialog");return n(),h(y,{class:"query-model-window",modelValue:d.visible,"onUpdate:modelValue":t[0]||(t[0]=V=>d.visible=V),fullscreen:"","append-to-body":"","show-close":!1},{header:p(()=>[ml,_("div",_l,[v(r,{"model-value":l.currentDatabase},null,8,["model-value"]),v(b,{onClick:o.close},{default:p(()=>[v(f)]),_:1},8,["onClick"])])]),default:p(()=>[v(S,{"database-id":l.currentDatabase},null,8,["database-id"])]),_:1},8,["modelValue"])}const pl=I(cl,[["render",hl]]),vl="/images/database/icon-design.svg";const bl={name:"QueryModelSelect",components:{QueryModelWindow:pl,QueryModelFieldSetting:rl},props:{modelValue:{},valueKey:{default:"value"},variable:{required:!0}},computed:{...K(["models","globalLoading","currentDatabaseConnect"]),fieldVariableGroup(){return this.variable.children||[]},currentModel(){return this.modelValue==null?null:this.models.find(l=>l.id===this.modelValue)}},watch:{"globalLoading.models":{immediate:!0,handler(l){l||this.handleChange(this.modelValue)}},"models.length"(){this.handleChange(this.modelValue)}},methods:{handleChange(l){if(!this.globalLoading.models){if(this.modelValue!==l&&this.fieldVariableGroup.forEach(t=>{t[this.valueKey]=[]}),this.models.find(t=>t.id===l)==null){this.$emit("update:modelValue",null),this.$emit("change",null);return}this.$emit("update:modelValue",l),this.$emit("change")}},refreshFieldSetting(){for(const l of this.fieldVariableGroup){const t=this.$refs[`${l.name}FieldSetting`];t&&t[0]&&t[0].refresh()}}}},G=l=>(Q("data-v-6d47634a"),l=l(),D(),l),fl={class:"query-model-select"},gl={class:"option-content"},yl={class:"text-info-1"},Vl=G(()=>_("img",{src:vl,alt:"查询模型"},null,-1)),Sl=G(()=>_("p",null,null,-1)),kl={key:0,class:"connect-error"},Il={key:1,class:"field-settings"};function Fl(l,t,e,a,d,o){const r=s("el-option"),f=s("el-select"),b=s("el-button"),S=s("QueryModelWindow"),y=s("QueryModelFieldSetting");return n(),c(k,null,[_("div",fl,[v(f,{"popper-class":"model-select__popper","model-value":e.modelValue,clearable:"",onChange:o.handleChange},{default:p(()=>[(n(!0),c(k,null,C(l.models,V=>(n(),h(r,{key:V.id,value:V.id,label:V.name},{default:p(()=>[_("p",gl,[_("span",null,g(V.name),1),_("span",yl,g(V.comment),1)])]),_:2},1032,["value","label"]))),128))]),_:1},8,["model-value","onChange"]),v(b,{class:"button-icon",type:"primary",onClick:t[0]||(t[0]=V=>l.$refs.queryModelWindow.open())},{default:p(()=>[Vl]),_:1}),Sl,v(S,{ref:"queryModelWindow",onClose:o.refreshFieldSetting},null,8,["onClose"])]),l.currentDatabaseConnect.error!=null?(n(),c("p",kl,"数据库连接失败："+g(l.currentDatabaseConnect.error),1)):F("",!0),o.currentModel!=null&&o.fieldVariableGroup.length>0?(n(),c("ul",Il,[(n(!0),c(k,null,C(o.fieldVariableGroup,V=>(n(),c("li",{key:V.label},[v(y,{ref_for:!0,ref:`${V.name}FieldSetting`,"value-key":e.valueKey,model:o.currentModel,group:V,onChange:t[1]||(t[1]=u=>l.$emit("change"))},null,8,["value-key","model","group"])]))),128))])):F("",!0)],64)}const Cl=I(bl,[["render",Fl],["__scopeId","data-v-6d47634a"]]);const wl={name:"VariableInput",components:{InstallNumberInput:R,InstallSelect:j,DataSourceSelect:N,QueryModelSelect:Cl,TableSelect:Ae,InstallCheckbox:E,InstallRadio:W,InstallInput:L,InstallSwitch:A},props:{variable:{required:!0},valueKey:{default:"value"}},computed:{inputType(){return this.variable.inputType}}},Tl={class:"variable-input"};function xl(l,t,e,a,d,o){const r=s("InstallInput"),f=s("InstallNumberInput"),b=s("InstallSelect"),S=s("InstallCheckbox"),y=s("InstallRadio"),V=s("InstallSwitch"),u=s("DataSourceSelect"),i=s("TableSelect"),w=s("QueryModelSelect");return n(),c("div",Tl,[e.variable.inputType==="input"?(n(),h(r,{key:0,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[0]||(t[0]=m=>e.variable[e.valueKey]=m),onInput:t[1]||(t[1]=m=>l.$emit("change",m))},null,8,["modelValue"])):e.variable.inputType==="number_input"?(n(),h(f,{key:1,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[2]||(t[2]=m=>e.variable[e.valueKey]=m),onInput:t[3]||(t[3]=m=>l.$emit("change",m))},null,8,["modelValue"])):e.variable.inputType==="textarea"?(n(),h(r,{key:2,type:"textarea",modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[4]||(t[4]=m=>e.variable[e.valueKey]=m),onInput:t[5]||(t[5]=m=>l.$emit("change",m))},null,8,["modelValue"])):e.variable.inputType==="select"?(n(),h(b,{key:3,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[6]||(t[6]=m=>e.variable[e.valueKey]=m),options:e.variable.options,onChange:t[7]||(t[7]=m=>l.$emit("change",m))},null,8,["modelValue","options"])):e.variable.inputType==="checkbox"?(n(),h(S,{key:4,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[8]||(t[8]=m=>e.variable[e.valueKey]=m),options:e.variable.options,onChange:t[9]||(t[9]=m=>l.$emit("change",m))},null,8,["modelValue","options"])):e.variable.inputType==="radio"?(n(),h(y,{key:5,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[10]||(t[10]=m=>e.variable[e.valueKey]=m),options:e.variable.options,onChange:t[11]||(t[11]=m=>l.$emit("change",m))},null,8,["modelValue","options"])):e.variable.inputType==="switch"?(n(),h(V,{key:6,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[12]||(t[12]=m=>e.variable[e.valueKey]=m),onInput:t[13]||(t[13]=m=>l.$emit("change",m))},null,8,["modelValue"])):e.variable.inputType==="datasource"?(n(),h(u,{key:7,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[14]||(t[14]=m=>e.variable[e.valueKey]=m),"with-prefix":!1,"with-block":!0,onChange:t[15]||(t[15]=m=>l.$emit("change",m))},null,8,["modelValue"])):e.variable.inputType==="table"?(n(),h(i,{key:8,variable:e.variable,"value-key":e.valueKey,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[16]||(t[16]=m=>e.variable[e.valueKey]=m),onChange:t[17]||(t[17]=m=>l.$emit("change",m))},null,8,["variable","value-key","modelValue"])):e.variable.inputType==="query_model"?(n(),h(w,{key:9,variable:e.variable,"value-key":e.valueKey,modelValue:e.variable[e.valueKey],"onUpdate:modelValue":t[18]||(t[18]=m=>e.variable[e.valueKey]=m),onChange:t[19]||(t[19]=m=>l.$emit("change",m))},null,8,["variable","value-key","modelValue"])):F("",!0)])}const Nl=I(wl,[["render",xl],["__scopeId","data-v-ea68e2f3"]]);const Ml={name:"ServiceCodeErrorWindow",data(){return{visible:!1,error:null}},methods:{open(l){this.error=l,this.visible=!0}}},Kl={class:"window-header-wrap"},Ol={class:"title"},Ul={class:"tip"},$l={class:"window-content-wrap"};function ql(l,t,e,a,d,o){const r=s("CircleCloseFilled"),f=s("el-icon"),b=s("el-dialog");return n(),h(b,{modelValue:d.visible,"onUpdate:modelValue":t[0]||(t[0]=S=>d.visible=S),width:"1000px",class:"service-code-error-window","show-close":!1},{header:p(()=>[_("div",Kl,[_("div",Ol,[v(f,null,{default:p(()=>[v(r)]),_:1}),_("h5",null,g(l.$t("service.serviceCodeErrorTitle")),1)]),_("p",Ul,g(l.$t("service.serviceCodeErrorTip")),1)])]),default:p(()=>[_("div",$l,[_("p",null,"at "+g(d.error.position),1),_("pre",null,g(d.error.message),1)])]),_:1},8,["modelValue"])}const El=I(Ml,[["render",ql]]);export{qe as F,W as I,he as M,fe as O,El as S,J as V,Nl as a,L as b,E as c,B as g,M as i};
