import{L as $,P as C,N as T,m as q,n as F,h as E,Q as L,R as B,_ as M,r as u,o as l,c as o,a as p,t as c,b as d,w as _,e as V,j as f,F as m,g as v,f as P,S as N}from"./index-1bde5b44.js";import{S as R,F as G,M as O,V as A,I as z,a as J,b as Q,i as b,g as U}from"./ServiceCodeErrorWindow-a7ccd212.js";import{b as H}from"./service.version-2a67cb84.js";import{F as K}from"./FormItemTip-20d06b90.js";const X={name:"ServiceInstaller",components:{FormItemTip:K,ServiceCodeErrorWindow:R,MergeWindow:$,ProjectSelect:C,DirectorySelect:T,FieldSetting:G,MySqlFieldSelect:O,VariableInput:A,InstallRadio:z,InstallInput:J,InstallCheckbox:Q},props:{installing:{},uninstalling:{},space:{required:!0},service:{required:!0},plugin:{required:!1},servicePrice:{required:!0},serviceLease:{required:!1},version:{required:!0},withProject:{default:!0},projectConfig:{},withTitle:{default:!1},withInstallButton:{default:!1}},data(){return{isWorking:{install:!1,uninstall:!1},versionData:null,variables:[]}},computed:{...q(["currentProject","currentProjectDetail","currentDatabase","currentDatabaseDetail"]),isPlugin(){return this.plugin!=null},serviceVariables(){return this.variables},contentWrapStyle(){return this.withTitle?"border-top: 3px; margin-top: 20px;":"padding-top: 0; border-top: 0;margin-top: 0;"},unique(){return[this.space,this.service,this.version]}},watch:{unique(){this.fetchVersion()},"isWorking.install":function(){this.$emit("update:installing",this.isWorking.install)},"isWorking.uninstall":function(){this.$emit("update:uninstalling",this.isWorking.uninstall)},projectConfig(){this.initVariables()},plugin(){this.initVariables()}},methods:{...F(["setInstallData"]),...E(["refreshBalance"]),fetchVersion(){H({space:this.space,service:this.service,plugin:this.plugin,version:this.version}).then(e=>{this.versionData=e,this.initVariables()}).catch(e=>{this.$tip.apiFailed(e)})},install(){if(this.serviceLease!=null){this.__install();return}if(this.servicePrice<50){this.__install();return}this.installConfirm(this.servicePrice).then(()=>{this.__install()}).catch(()=>{})},initVariables(){this.versionData!=null&&(this.variables=JSON.parse(this.versionData.variables).map(e=>this.__initVariableValue(e)))},__install(){if(this.isWorking.install)return;if(this.isWorking.install=!0,this.currentProject==null||this.currentProject===""){this.$tip.warning(this.$t("service.selectProject")),this.isWorking.install=!1;return}const e=this.__getInstallVariables(this.variables);if(!this.__checkVariables(e)){this.isWorking.install=!1;return}L({projectId:this.currentProject,database:this.currentDatabase,space:this.space,service:this.service,plugin:this.plugin,version:this.version,variables:e}).then(t=>{this.isWorking.install=!1,this.$tip.success(this.$t("service.installSuccessfully")),this.setInstallData(t),this.refreshBalance(),this.$emit("installed")}).catch(t=>{if(t.code===6e3){this.$refs.serviceCodeErrorWindow.open(t.errorData);return}this.$tip.apiFailed(t)}).finally(()=>{this.isWorking.install=!1})},uninstall(){if(this.serviceLease!=null){this.__uninstall();return}if(this.servicePrice<50){this.__uninstall();return}this.uninstallConfirm().then(()=>{this.__uninstall()}).catch(()=>{})},__uninstall(){this.isWorking.uninstall||(this.isWorking.uninstall=!0,B({projectId:this.currentProject,database:this.currentDatabase,space:this.space,service:this.service,plugin:this.plugin,version:this.version,variables:this.__getInstallVariables(this.variables)}).then(e=>{this.isWorking.uninstall=!1,this.$tip.success(this.$t("service.uninstallSuccessfully")),this.setInstallData(e),this.$emit("uninstalled")}).catch(e=>{if(e.code===6e3){this.$refs.serviceCodeErrorWindow.open(e.errorData);return}this.$tip.apiFailed(e)}).finally(()=>{this.isWorking.uninstall=!1}))},__checkVariables(e,t){for(const i of e){if(i.inputType==="query_model"||i.inputType==="table"){for(const n of i.children){const s=n.value;for(const r of n.children){if(!r.required)continue;const h=s.find(g=>b(g[r.name]));if(h!=null)return this.$tip.warning(this.$t("service.fieldMissingValueTip",{fieldGroupLabel:n.label,emptyFieldName:h.name,fieldVariableLabel:r.label})),!1}}continue}if(i.inputType==="select"){const n=i.value;if(i.required&&n.value==null)return this.__tipEmptyVariable(i,t),!1;if(n.value!=null){const s=i.options.find(r=>r.value===n.value);if(s.settings.length>0){for(const r of s.settings)if(b(n.settings[r.name]))return this.$tip.warning(this.$t("service.variableMissingSettingTip",{variable:i.label,settingLabel:r.label})),!1}}continue}if(i.type==="group"){if(!this.__checkVariables(i.children,i.label))return!1;continue}if(b(i.value))return this.__tipEmptyVariable(i,t),!1}return!0},__tipEmptyVariable(e,t){t!=null?this.$tip.warning(this.$t("service.missingGroupVariableValueTip",{variable:e.label,groupName:t})):this.$tip.warning(this.$t("service.missingVariableValueTip",{variable:e.label}))},__getInstallVariables(e){return e.map(t=>{if(t.inputType==="select"){const i=t.options.find(s=>s.value===t.value.value);if(i==null)return t;const n={};for(const s of i.settings)n[s.name]=s.value;t.value.settings=n}return t.type==="group"&&(t.children=this.__getInstallVariables(t.children)),t})},__initVariableValue(e,t){if(t==null&&this.projectConfig!=null)if(this.isPlugin){const n=(this.projectConfig.plugins||this.projectConfig.services)[this.plugin];if(n!=null){const s=n.variables.findLast(r=>r.name===e.name);s!=null&&(t=s.value)}if(t==null){const s=this.projectConfig.service||this.projectConfig.main;let r=null;for(const g in s){r=g;break}const h=s[r].variables[e.name];t=h,h!=null&&h.constructor!==e.defaultValue.constructor&&(t=null)}}else{const n=(this.projectConfig.service||this.projectConfig.main)[this.service];if(n!=null){const s=n.variables.findLast(r=>r.name===e.name);s!=null&&(t=s.value)}}if(t!=null){if(e.inputType==="table"||e.inputType==="query_model"){for(const i in t.settings){const n=e.children.find(s=>s.name===i);n!=null&&(n.value=t.settings[i])}return e.value=t.value,e}return e.type==="group"?(e.children.forEach(i=>this.__initVariableValue(i,t[i.name])),e):(e.value=t,e)}if(t=e.defaultValue,t=t??U(e.inputType),e.inputType==="table"||e.inputType==="query_model"){for(const i of e.children)i.value=i.defaultValue;return e.value=t,e}return e.type==="group"?(e.children.forEach(i=>{i.value=i.defaultValue}),e):(e.value=t,e)}},created(){this.fetchVersion()}},Y={class:"service-installer"},Z={key:0,class:"nav"},x={class:"title"},ee={key:0,class:"install"},te={class:"install-tip"},ie={class:"form-wrap"},se={key:1,class:"label-wrap"},ne={key:1,class:"group-vars"},re={class:"text-info-1 text-mini"},le={key:0},ae={key:1,class:"parameters-holder"};function oe(e,t,i,n,s,r){const h=u("el-button"),g=u("ProjectSelect"),k=u("FormItemTip"),j=u("el-form-item"),D=u("ArrowRight"),S=u("el-icon"),w=u("VariableInput"),I=u("el-form"),W=u("ServiceCodeErrorWindow");return l(),o("div",Y,[i.withTitle?(l(),o("div",Z,[p("div",x,[p("h4",null,"@"+c(i.space)+"/"+c(i.service)+c(i.version==null?"":" · "+i.version.toUpperCase())+" · "+c(e.$t("service.install2")),1)]),i.withInstallButton?(l(),o("div",ee,[d(h,{type:"important",onClick:r.install,disabled:s.isWorking.install},{default:_(()=>[V(c(s.isWorking.install?e.$t("service.installing"):e.$t("service.install")),1)]),_:1},8,["onClick","disabled"])])):f("",!0)])):f("",!0),p("div",{class:"content-wrap",style:N(r.contentWrapStyle)},[i.withProject||r.serviceVariables.length>0?(l(),o(m,{key:0},[p("p",te,c(e.$t("service.withParametersTip")),1),p("div",ie,[d(I,null,{default:_(()=>[i.withProject?(l(),v(j,{key:0,label:e.$t("project.project"),required:"",class:"form-item-project"},{default:_(()=>[d(g,{"model-value":e.currentProject,"with-block":!0,"with-prefix":!1,onChange:t[0]||(t[0]=a=>e.$emit("change-project",a))},null,8,["model-value"]),e.currentProjectDetail!=null?(l(),v(k,{key:0,content:`服务安装后代码将写入<em>${e.currentProjectDetail.codespace}</em>目录。`},null,8,["content"])):f("",!0)]),_:1},8,["label"])):f("",!0),(l(!0),o(m,null,P(r.serviceVariables,a=>(l(),o(m,null,[a.hidden?f("",!0):(l(),v(j,{key:a.name,label:a.label,required:a.required},{label:_(()=>[a.type==="variable"?(l(),o(m,{key:0},[V(c(a.label),1)],64)):(l(),o("div",se,[p("span",null,c(a.label),1),d(S,null,{default:_(()=>[d(D)]),_:1})]))]),default:_(()=>[a.type==="variable"?(l(),v(w,{key:0,variable:a},null,8,["variable"])):a.type==="group"?(l(),o("ul",ne,[(l(!0),o(m,null,P(a.children,y=>(l(),o("li",{key:`${a.name}_${y.name}`},[p("label",re,[y.required?(l(),o("em",le,"*")):f("",!0),V(c(y.label),1)]),d(w,{variable:y},null,8,["variable"])]))),128))])):f("",!0),a.inputType==="datasource"&&e.currentDatabaseDetail!=null?(l(),v(k,{key:2,content:`基础信息：${e.currentDatabaseDetail.host}:${e.currentDatabaseDetail.port}/${e.currentDatabaseDetail.schema}`},null,8,["content"])):f("",!0)]),_:2},1032,["label","required"]))],64))),256))]),_:1})])],64)):(l(),o("div",ae,[p("p",null,c(e.$t("service.withoutParametersTip")),1)]))],4),d(W,{ref:"serviceCodeErrorWindow"},null,512)])}const fe=M(X,[["render",oe],["__scopeId","data-v-adacd1d3"]]);export{fe as S};
